# 前后端通信机制

<cite>
**本文档引用的文件**   
- [index.ts](file://web/src/services/zquant/index.ts)
- [auth.ts](file://web/src/services/zquant/auth.ts)
- [backtest.ts](file://web/src/services/zquant/backtest.ts)
- [factor.ts](file://web/src/services/zquant/factor.ts)
- [main.py](file://zquant/main.py)
- [auth.py](file://zquant/api/v1/auth.py)
- [backtest.py](file://zquant/api/v1/backtest.py)
- [factor.py](file://zquant/api/v1/factor.py)
- [security.py](file://zquant/middleware/security.py)
- [logging.py](file://zquant/middleware/logging.py)
- [deps.py](file://zquant/api/deps.py)
- [auth.py](file://zquant/services/auth.py)
- [backtest.py](file://zquant/services/backtest.py)
- [factor.py](file://zquant/services/factor.py)
- [requestErrorConfig.ts](file://web/src/requestErrorConfig.ts)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [前端API客户端封装](#前端api客户端封装)
3. [后端FastAPI应用入口](#后端fastapi应用入口)
4. [认证流程](#认证流程)
5. [回测任务创建流程](#回测任务创建流程)
6. [因子配置更新流程](#因子配置更新流程)
7. [错误处理与重试策略](#错误处理与重试策略)
8. [中间件与安全机制](#中间件与安全机制)

## 项目结构

zquant系统采用前后端分离架构，前端基于React框架构建，后端采用FastAPI框架。前端代码位于`web/`目录，后端代码位于`zquant/`目录。

```mermaid
graph TD
subgraph "前端"
A[web/src/services/zquant/] --> B[API客户端封装]
B --> C[auth.ts]
B --> D[backtest.ts]
B --> E[factor.ts]
end
subgraph "后端"
F[zquant/main.py] --> G[FastAPI应用]
G --> H[api/v1/]
H --> I[auth.py]
H --> J[backtest.py]
H --> K[factor.py]
end
B --> |HTTP请求| G
G --> |HTTP响应| B
```

**图源**
- [web/src/services/zquant/](file://web/src/services/zquant/)
- [zquant/main.py](file://zquant/main.py)
- [zquant/api/v1/](file://zquant/api/v1/)

## 前端API客户端封装

前端在`web/src/services/zquant/`目录下封装了API客户端，使用UmiJS的`request`函数（基于Fetch API）与后端进行通信。每个服务模块（如认证、回测、因子）都有独立的TS文件进行封装。

### 认证服务封装

```mermaid
sequenceDiagram
participant 前端 as 前端
participant 后端 as 后端
前端->>后端 : POST /api/v1/auth/login
后端-->>前端 : {access_token, refresh_token}
前端->>后端 : POST /api/v1/auth/refresh
后端-->>前端 : {access_token, refresh_token}
前端->>后端 : POST /api/v1/auth/logout
后端-->>前端 : {message : "登出成功"}
```

**图源**
- [auth.ts](file://web/src/services/zquant/auth.ts)
- [auth.py](file://zquant/api/v1/auth.py)

### 回测服务封装

```mermaid
sequenceDiagram
participant 前端 as 前端
participant 后端 as 后端
前端->>后端 : POST /api/v1/backtest/run
后端-->>前端 : 回测任务响应
前端->>后端 : GET /api/v1/backtest/tasks
后端-->>前端 : 任务列表
前端->>后端 : GET /api/v1/backtest/tasks/{task_id}
后端-->>前端 : 任务详情
前端->>后端 : GET /api/v1/backtest/tasks/{task_id}/result
后端-->>前端 : 回测结果
```

**图源**
- [backtest.ts](file://web/src/services/zquant/backtest.ts)
- [backtest.py](file://zquant/api/v1/backtest.py)

### 因子服务封装

```mermaid
sequenceDiagram
participant 前端 as 前端
participant 后端 as 后端
前端->>后端 : GET /api/v1/factor/definitions
后端-->>前端 : 因子定义列表
前端->>后端 : POST /api/v1/factor/definitions
后端-->>前端 : 新因子定义
前端->>后端 : PUT /api/v1/factor/definitions/{id}
后端-->>前端 : 更新后的因子定义
前端->>后端 : DELETE /api/v1/factor/definitions/{id}
后端-->>前端 : 204 No Content
```

**图源**
- [factor.ts](file://web/src/services/zquant/factor.ts)
- [factor.py](file://zquant/api/v1/factor.py)

## 后端FastAPI应用入口

后端入口文件`zquant/main.py`负责创建FastAPI应用实例，配置中间件，并注册各个API路由模块。

```mermaid
classDiagram
class FastAPI {
+title : str
+version : str
+description : str
}
class CORSMiddleware {
+allow_origins : list
+allow_credentials : bool
+allow_methods : list
+allow_headers : list
}
class SecurityHeadersMiddleware {
+X-Content-Type-Options : nosniff
+X-Frame-Options : DENY
+X-XSS-Protection : 1; mode=block
}
class LoggingMiddleware {
+记录请求ID
+记录请求/响应
+性能监控
}
FastAPI --> CORSMiddleware : "使用"
FastAPI --> SecurityHeadersMiddleware : "使用"
FastAPI --> LoggingMiddleware : "使用"
FastAPI --> auth : "注册路由"
FastAPI --> backtest : "注册路由"
FastAPI --> factor : "注册路由"
```

**图源**
- [main.py](file://zquant/main.py)

## 认证流程

系统采用JWT（JSON Web Token）进行认证，包含访问Token和刷新Token机制。

```mermaid
sequenceDiagram
participant 用户 as 用户
participant 前端 as 前端
participant 后端 as 后端
用户->>前端 : 输入用户名密码
前端->>后端 : POST /api/v1/auth/login
后端->>后端 : 验证用户凭证
后端-->>前端 : {access_token, refresh_token}
前端->>前端 : 存储Token到localStorage
前端->>后端 : 带Bearer Token的API请求
后端->>后端 : 验证Token有效性
后端-->>前端 : API响应
前端->>后端 : Token过期，请求刷新
后端->>后端 : 验证refresh_token
后端-->>前端 : 新的{access_token, refresh_token}
```

**图源**
- [auth.ts](file://web/src/services/zquant/auth.ts)
- [auth.py](file://zquant/api/v1/auth.py)
- [deps.py](file://zquant/api/deps.py)
- [auth.py](file://zquant/services/auth.py)

## 回测任务创建流程

回测任务的创建涉及前端请求、后端路由分发、服务层调用和数据库操作。

```mermaid
sequenceDiagram
participant 前端 as 前端
participant 后端 as 后端
participant 服务层 as 服务层
participant 数据库 as 数据库
前端->>后端 : POST /api/v1/backtest/run
后端->>后端 : 解析请求参数
后端->>服务层 : 调用BacktestService.create_task()
服务层->>数据库 : 创建BacktestTask记录
数据库-->>服务层 : 返回任务对象
服务层->>服务层 : 异步运行回测
服务层->>服务层 : 调用BacktestEngine
服务层->>服务层 : 计算绩效指标
服务层->>数据库 : 保存BacktestResult
数据库-->>服务层 : 返回结果对象
服务层-->>后端 : 返回任务响应
后端-->>前端 : 返回任务详情
```

**图源**
- [backtest.ts](file://web/src/services/zquant/backtest.ts)
- [backtest.py](file://zquant/api/v1/backtest.py)
- [backtest.py](file://zquant/services/backtest.py)

## 因子配置更新流程

因子配置更新展示了系统如何处理复杂的业务逻辑和数据验证。

```mermaid
sequenceDiagram
participant 前端 as 前端
participant 后端 as 后端
participant 服务层 as 服务层
participant 数据库 as 数据库
前端->>后端 : PUT /api/v1/factor/configs/{factor_id}
后端->>后端 : 验证管理员权限
后端->>后端 : 解析请求体
后端->>服务层 : 调用FactorService.update_factor_config_by_id()
服务层->>数据库 : 获取当前配置
数据库-->>服务层 : 返回配置对象
服务层->>服务层 : 验证所有模型存在
服务层->>服务层 : 验证只有一个默认配置
服务层->>数据库 : 更新配置并保存
数据库-->>服务层 : 返回更新后的配置
服务层-->>后端 : 返回响应
后端-->>前端 : 返回更新后的配置
```

**图源**
- [factor.ts](file://web/src/services/zquant/factor.ts)
- [factor.py](file://zquant/api/v1/factor.py)
- [factor.py](file://zquant/services/factor.py)

## 错误处理与重试策略

系统实现了完善的错误处理机制，从前端到后端都有相应的处理策略。

```mermaid
flowchart TD
Start([前端发起请求]) --> RequestError{"请求错误类型?"}
RequestError --> |HTTP 401| Handle401["处理401未授权"]
Handle401 --> ClearToken["清除localStorage中的Token"]
ClearToken --> RedirectLogin["跳转到登录页面"]
RedirectLogin --> ShowMessage["显示'登录已过期'消息"]
RequestError --> |HTTP 422| Handle422["处理422验证错误"]
Handle422 --> ParseError["解析Pydantic验证错误"]
ParseError --> FormatMessage["格式化错误信息"]
FormatMessage --> ShowMessage
RequestError --> |网络错误| HandleNetwork["处理网络错误"]
HandleNetwork --> CheckInitializing{"是否在初始化阶段?"}
CheckInitializing --> |是| DelayMessage["延迟显示消息"]
CheckInitializing --> |否| ShowMessage
RequestError --> |其他错误| HandleOther["处理其他错误"]
HandleOther --> ShowMessage
ShowMessage --> End([错误处理完成])
```

**图源**
- [requestErrorConfig.ts](file://web/src/requestErrorConfig.ts)

## 中间件与安全机制

系统通过多层中间件实现安全防护、日志记录和性能监控。

```mermaid
graph TD
Request[HTTP请求] --> SecurityHeaders["安全响应头中间件"]
SecurityHeaders --> XSS["XSS防护中间件"]
XSS --> RateLimit["速率限制中间件"]
RateLimit --> Audit["审计日志中间件"]
Audit --> Logging["请求日志中间件"]
Logging --> Router["路由分发"]
Router --> AuthAPI["认证API"]
Router --> BacktestAPI["回测API"]
Router --> FactorAPI["因子API"]
AuthAPI --> Response[HTTP响应]
BacktestAPI --> Response
FactorAPI --> Response
Response --> Logging
Logging --> Audit
Audit --> RateLimit
RateLimit --> XSS
XSS --> SecurityHeaders
SecurityHeaders --> Client[客户端]
```

**图源**
- [main.py](file://zquant/main.py)
- [security.py](file://zquant/middleware/security.py)
- [logging.py](file://zquant/middleware/logging.py)