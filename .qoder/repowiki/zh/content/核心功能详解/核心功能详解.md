# 核心功能详解

<cite>
**本文档引用的文件**   
- [engine.py](file://zquant/backtest/engine.py)
- [context.py](file://zquant/backtest/context.py)
- [order.py](file://zquant/backtest/order.py)
- [cost.py](file://zquant/backtest/cost.py)
- [performance.py](file://zquant/backtest/performance.py)
- [base.py](file://zquant/factor/calculators/base.py)
- [factory.py](file://zquant/factor/calculators/factory.py)
- [turnover_rate.py](file://zquant/factor/calculators/turnover_rate.py)
- [manager.py](file://zquant/scheduler/manager.py)
- [common_executor.py](file://zquant/scheduler/executors/common_executor.py)
- [executor.py](file://zquant/scheduler/executor.py)
- [processor.py](file://zquant/data/processor.py)
- [storage.py](file://zquant/data/storage.py)
</cite>

## 目录
1. [回测引擎](#回测引擎)
2. [因子管理系统](#因子管理系统)
3. [任务调度系统](#任务调度系统)
4. [数据服务](#数据服务)

## 回测引擎

回测引擎是zquant系统的核心模块，负责执行策略、模拟交易和生成绩效报告。其主要功能包括策略执行、订单撮合、成本计算和绩效分析。

### 策略编写接口

回测引擎通过`Context`对象为策略提供统一的编程接口。策略开发者通过继承`BaseStrategy`类并实现`on_bar`方法来编写策略逻辑。`Context`对象提供了以下核心方法：

- `order(symbol, quantity, price)`: 下单接口，支持市价单和限价单。
- `order_target(symbol, target_quantity)`: 目标持仓下单。
- `order_value(symbol, value)`: 按金额下单。
- `order_target_value(symbol, target_value)`: 目标市值下单。
- `get_daily_basic(symbol, trade_date)`: 获取每日指标数据（如PE、PB、换手率等）。

```mermaid
classDiagram
class Context {
+current_date : date
+portfolio : Portfolio
+config : dict
+order(symbol, quantity, price) : str
+order_target(symbol, target_quantity) : str
+order_value(symbol, value) : str
+order_target_value(symbol, target_value) : str
+get_daily_basic(symbol, trade_date) : dict | None
}
class Portfolio {
+cash : float
+positions : dict[str, Position]
+total_value : float
+get_position(symbol) : Position
+update_position_value(symbol, price) : void
}
class Position {
+symbol : str
+quantity : float
+avg_cost : float
+current_price : float
+market_value : float
+profit : float
+profit_pct : float
}
Context --> Portfolio : "包含"
Portfolio --> Position : "包含"
```

**代码片段路径**
- [context.py](file://zquant/backtest/context.py#L82-L188)

### 回测执行流程

回测引擎的执行流程遵循事件驱动模型，主要步骤如下：

1. **初始化**: 加载配置、初始化投资组合、加载交易日历和价格数据。
2. **事件循环**: 遍历每个交易日，执行以下操作：
   - 撮合T-1日的订单（T+1延迟成交）。
   - 更新持仓市值。
   - 调用策略的`on_bar`方法。
3. **结果生成**: 计算最终投资组合价值和已成交订单列表。

```mermaid
sequenceDiagram
participant 策略 as 策略
participant 引擎 as 回测引擎
participant Context as Context
participant 订单 as 订单管理
策略->>Context : order(symbol, quantity)
Context->>引擎 : _create_order()
引擎->>订单 : 添加到pending_orders
loop 每个交易日
引擎->>引擎 : _match_orders()
引擎->>引擎 : _update_portfolio_values()
引擎->>策略 : on_bar(context, bar_data)
end
引擎->>引擎 : _get_results()
```

**代码片段路径**
- [engine.py](file://zquant/backtest/engine.py#L405-L454)

### 订单模拟与绩效分析机制

回测引擎实现了T+1延迟成交机制，订单在T日下单，T+1日以开盘价撮合。订单撮合时会检查涨跌停情况，涨停时买入订单被拒绝，跌停时卖出订单被拒绝。

成本计算包括佣金、印花税和滑点。佣金按交易金额的固定比例收取，有最低佣金限制；印花税仅在卖出时收取；滑点按交易金额的固定比例计算。

绩效分析模块提供全面的指标，包括累计收益率、年化收益率、最大回撤、波动率、夏普比率、胜率和盈亏比。

```mermaid
classDiagram
class BacktestEngine {
+db : Session
+strategy_class : type
+config : dict
+context : Context
+cost_calculator : CostCalculator
+pending_orders : dict[str, Order]
+filled_orders : list[Order]
+run() : dict[str, Any]
+_create_order() : str
+_match_orders() : void
+_fill_order() : void
+_update_portfolio() : void
}
class CostCalculator {
+config : CostConfig
+calculate_commission() : float
+calculate_tax() : float
+calculate_slippage() : float
+apply_costs_to_order() : void
}
class Order {
+order_id : str
+symbol : str
+side : OrderSide
+quantity : float
+price : float | None
+status : OrderStatus
+filled_quantity : float
+filled_price : float
+commission : float
+tax : float
+slippage : float
+order_date : date
+fill_date : date | None
+is_buy : bool
+is_sell : bool
+is_filled : bool
+total_cost : float
}
class PerformanceAnalyzer {
+engine : BacktestEngine
+benchmark_data : dict[date, float]
+calculate_metrics() : dict[str, Any]
+_calculate_total_return() : float
+_calculate_annual_return() : float
+_calculate_max_drawdown() : float
+_calculate_volatility() : float
+_calculate_sharpe_ratio() : float
+_calculate_alpha() : float
+_calculate_beta() : float
+_calculate_win_rate() : float
+_calculate_profit_loss_ratio() : float
}
BacktestEngine --> Context : "使用"
BacktestEngine --> CostCalculator : "使用"
BacktestEngine --> Order : "管理"
PerformanceAnalyzer --> BacktestEngine : "分析"
```

**代码片段路径**
- [engine.py](file://zquant/backtest/engine.py#L41-L498)
- [order.py](file://zquant/backtest/order.py#L32-L86)
- [cost.py](file://zquant/backtest/cost.py#L43-L116)
- [performance.py](file://zquant/backtest/performance.py#L36-L330)

## 因子管理系统

因子管理系统负责因子的定义、计算和存储。系统采用插件式架构，支持多种因子计算模型。

### 因子定义

因子通过`BaseFactorCalculator`基类定义，所有因子计算器必须继承该类并实现`calculate`和`validate_config`方法。因子配置通过`config`字典传递，支持灵活的参数化。

```mermaid
classDiagram
class BaseFactorCalculator {
<<abstract>>
+model_code : str
+config : dict
+calculate(db, code, trade_date) : float | None
+validate_config() : tuple[bool, str]
+get_required_data_tables() : list[str]
}
class TurnoverRateCalculator {
+MODEL_CODE : str = "turnover_rate"
+source : str
+field : str
+method : str | None
+window : int
+calculate(db, code, trade_date) : float | None
+validate_config() : tuple[bool, str]
+get_required_data_tables() : list[str]
}
BaseFactorCalculator <|-- TurnoverRateCalculator
```

**代码片段路径**
- [base.py](file://zquant/factor/calculators/base.py#L34-L82)
- [turnover_rate.py](file://zquant/factor/calculators/turnover_rate.py#L37-L188)

### 计算引擎（calculators/）

计算引擎采用工厂模式，通过`create_calculator`函数根据`model_code`创建对应的因子计算器实例。系统维护一个`CALCULATOR_REGISTRY`注册表，用于注册和查找因子计算器。

```mermaid
classDiagram
class FactorCalculatorFactory {
+CALCULATOR_REGISTRY : dict[str, type[BaseFactorCalculator]]
+register_calculator(model_code, calculator_class) : void
+create_calculator(model_code, config) : BaseFactorCalculator
+get_available_calculators() : list[str]
}
class TurnoverRateCalculator {
+calculate() : float | None
}
FactorCalculatorFactory --> TurnoverRateCalculator : "创建"
FactorCalculatorFactory --> BaseFactorCalculator : "注册"
```

**代码片段路径**
- [factory.py](file://zquant/factor/calculators/factory.py#L41-L90)

### 结果存储查询方式

因子计算结果按股票代码分表存储，表名为`zq_data_tustock_factor_{ts_code}`。系统提供`DataStorage`类用于写入因子数据，`DataProcessor`类用于查询因子数据。查询时支持单个股票和多个股票，多个股票查询通过视图`zq_data_tustock_factor_view`实现。

**代码片段路径**
- [storage.py](file://zquant/data/storage.py#L564-L697)
- [processor.py](file://zquant/data/processor.py#L579-L644)

## 任务调度系统

任务调度系统基于APScheduler实现，支持定时任务和手动任务的管理。

### 定时任务配置

定时任务通过`ScheduledTask`模型定义，支持Cron表达式和固定间隔两种调度方式。任务配置存储在数据库中，支持动态增删改查。

```mermaid
classDiagram
class ScheduledTask {
+id : int
+job_id : str
+name : str
+task_type : TaskType
+cron_expression : str | None
+interval_seconds : int | None
+max_retries : int
+retry_interval : int
+paused : bool
+config : JSON
}
class TaskExecution {
+id : int
+task_id : int
+status : TaskStatus
+start_time : datetime
+end_time : datetime
+duration_seconds : int
+retry_count : int
+error_message : str | None
+result : JSON
}
class TaskSchedulerManager {
+scheduler : BackgroundScheduler
+_running : bool
+start() : void
+shutdown() : void
+add_task(task) : bool
+remove_task(job_id) : bool
+pause_task(job_id) : bool
+resume_task(job_id) : bool
+trigger_task(job_id) : bool
+get_job_status(job_id) : dict[str, Any] | None
}
TaskSchedulerManager --> ScheduledTask : "管理"
TaskSchedulerManager --> TaskExecution : "创建"
```

**代码片段路径**
- [manager.py](file://zquant/scheduler/manager.py#L46-L475)

### 执行器（executors/）模型

执行器采用策略模式，`TaskExecutor`是所有执行器的基类。`CommonTaskExecutor`作为通用执行器，根据`task_action`字段路由到不同的具体执行器。`DataSyncExecutor`负责数据同步任务，使用策略模式委托给具体的同步策略。

```mermaid
classDiagram
class TaskExecutor {
<<abstract>>
+get_task_type() : TaskType
+execute(db, config, execution) : dict[str, Any]
}
class CommonTaskExecutor {
+execute(db, config, execution) : dict[str, Any]
+_infer_task_action_from_type() : str | None
+_infer_task_action_from_string() : str | None
}
class DataSyncExecutor {
+execute(db, config, execution) : dict[str, Any]
+_infer_task_action_from_type() : str | None
+_infer_task_action_from_string() : str | None
}
class WorkflowExecutor {
+execute(db, config, execution) : dict[str, Any]
}
TaskExecutor <|-- CommonTaskExecutor
TaskExecutor <|-- DataSyncExecutor
TaskExecutor <|-- WorkflowExecutor
```

**代码片段路径**
- [executor.py](file://zquant/scheduler/executor.py#L36-L152)
- [common_executor.py](file://zquant/scheduler/executors/common_executor.py#L37-L135)

### 工作流管理

工作流管理通过`WorkflowExecutor`实现，支持复杂任务的编排。工作流任务的`config`中包含`steps`字段，定义了任务执行的步骤列表。每个步骤可以是其他任务的引用，支持串行和并行执行。

## 数据服务

数据服务负责数据的ETL流程、存储结构和访问接口。

### 数据ETL流程

数据ETL流程由`DataScheduler`类管理，支持同步股票列表、交易日历、日线数据、每日指标数据等。ETL任务通过命令行脚本触发，如`sync_stock_list.py`、`sync_daily_data.py`等。

```mermaid
flowchart TD
A[开始] --> B{任务类型}
B --> |sync_stock_list| C[同步股票列表]
B --> |sync_trading_calendar| D[同步交易日历]
B --> |sync_daily_data| E[同步日线数据]
B --> |sync_daily_basic_data| F[同步每日指标数据]
C --> G[写入数据库]
D --> G
E --> G
F --> G
G --> H[更新视图]
H --> I[结束]
```

**代码片段路径**
- [sync_daily_basic_data.py](file://zquant/scheduler/job/sync_daily_basic_data.py#L49-L122)

### 存储结构

数据存储采用分表策略，按股票代码分表存储，以提高查询性能。主要数据表包括：
- `zq_data_tustock_{ts_code}`: 股票基础信息
- `zq_data_tustock_daily_{ts_code}`: 日线数据
- `zq_data_tustock_daily_basic_{ts_code}`: 每日指标数据
- `zq_data_tustock_factor_{ts_code}`: 因子数据

系统创建视图`zq_data_tustock_daily_view`、`zq_data_tustock_daily_basic_view`等，用于查询多个股票的数据。

**代码片段路径**
- [storage.py](file://zquant/data/storage.py#L57-L767)

### 访问接口

数据访问通过`DataProcessor`类提供，支持按股票代码、日期范围查询数据。查询接口返回字典列表，包含所有字段的值。对于大量数据查询，系统提供批量查询接口，优化性能。

**代码片段路径**
- [processor.py](file://zquant/data/processor.py#L46-L528)