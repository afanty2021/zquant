# 回测引擎

<cite>
**本文档引用文件**   
- [engine.py](file://zquant/backtest/engine.py)
- [context.py](file://zquant/backtest/context.py)
- [order.py](file://zquant/backtest/order.py)
- [cost.py](file://zquant/backtest/cost.py)
- [performance.py](file://zquant/backtest/performance.py)
- [strategy.py](file://zquant/backtest/strategy.py)
- [simple_ma.py](file://zquant/strategy/examples/simple_ma.py)
- [dual_ma.py](file://zquant/strategy/examples/dual_ma.py)
- [rsi_strategy.py](file://zquant/strategy/examples/rsi_strategy.py)
- [backtest.py](file://zquant/services/backtest.py)
- [backtest.py](file://zquant/api/v1/backtest.py)
- [index.tsx](file://web/src/pages/backtest/index.tsx)
- [create.tsx](file://web/src/pages/backtest/create.tsx)
- [backtest.ts](file://web/src/services/zquant/backtest.ts)
- [backtest.py](file://zquant/models/backtest.py)
</cite>

## 目录
1. [引言](#引言)
2. [核心架构与流程](#核心架构与流程)
3. [BacktestEngine核心流程](#backtestengine核心流程)
4. [BacktestContext状态管理](#backtestcontext状态管理)
5. [Order订单模拟机制](#order订单模拟机制)
6. [交易成本计算](#交易成本计算)
7. [绩效指标生成](#绩效指标生成)
8. [策略接口与实现](#策略接口与实现)
9. [策略代码示例](#策略代码示例)
10. [数据服务集成](#数据服务集成)
11. [前端数据交互](#前端数据交互)
12. [性能优化策略](#性能优化策略)
13. [常见问题排查](#常见问题排查)
14. [结论](#结论)

## 引言
zquant回测引擎是一个完整的量化策略回测系统，提供从策略编写、市场数据注入、订单执行模拟到绩效分析的全流程支持。该引擎采用模块化设计，核心组件包括回测引擎、上下文管理、订单系统、成本计算器和绩效分析器。系统支持用户通过继承BaseStrategy类实现自定义策略，并通过context对象与回测环境交互。引擎与数据服务层紧密集成，能够获取历史行情数据，并通过API与前端页面进行数据交互，为用户提供直观的回测结果展示。

## 核心架构与流程

```mermaid
graph TD
A[用户策略] --> B[BacktestEngine]
B --> C[BacktestContext]
B --> D[Order]
B --> E[CostCalculator]
B --> F[PerformanceAnalyzer]
B --> G[DataProcessor]
C --> H[Portfolio]
C --> I[Position]
D --> J[OrderStatus]
D --> K[OrderSide]
E --> L[CostConfig]
F --> M[绩效指标]
G --> N[价格数据]
G --> O[每日指标数据]
```

**图示来源**  
- [engine.py](file://zquant/backtest/engine.py#L41-L498)
- [context.py](file://zquant/backtest/context.py#L32-L188)
- [order.py](file://zquant/backtest/order.py#L32-L86)
- [cost.py](file://zquant/backtest/cost.py#L33-L116)
- [performance.py](file://zquant/backtest/performance.py#L36-L330)
- [strategy.py](file://zquant/backtest/strategy.py#L33-L82)

**本节来源**  
- [engine.py](file://zquant/backtest/engine.py#L41-L498)
- [context.py](file://zquant/backtest/context.py#L32-L188)
- [order.py](file://zquant/backtest/order.py#L32-L86)
- [cost.py](file://zquant/backtest/cost.py#L33-L116)
- [performance.py](file://zquant/backtest/performance.py#L36-L330)
- [strategy.py](file://zquant/backtest/strategy.py#L33-L82)

## BacktestEngine核心流程

```mermaid
sequenceDiagram
participant 用户策略 as 用户策略
participant 回测引擎 as BacktestEngine
participant 上下文 as BacktestContext
participant 订单系统 as Order
participant 成本计算器 as CostCalculator
participant 绩效分析器 as PerformanceAnalyzer
回测引擎->>回测引擎 : 初始化引擎
回测引擎->>上下文 : 创建Context
回测引擎->>回测引擎 : 加载价格数据
回测引擎->>回测引擎 : 加载每日指标数据
回测引擎->>回测引擎 : 创建策略实例
loop 每个交易日
回测引擎->>回测引擎 : 撮合T-1日订单
回测引擎->>回测引擎 : 更新持仓市值
回测引擎->>回测引擎 : 获取K线数据
回测引擎->>用户策略 : 调用on_bar方法
用户策略->>上下文 : 调用order下单
上下文->>回测引擎 : 拦截下单请求
回测引擎->>订单系统 : 创建订单
订单系统->>回测引擎 : 返回订单ID
回测引擎->>回测引擎 : 记录待成交订单
end
回测引擎->>绩效分析器 : 计算绩效指标
回测引擎->>回测引擎 : 返回回测结果
```

**图示来源**  
- [engine.py](file://zquant/backtest/engine.py#L41-L498)

**本节来源**  
- [engine.py](file://zquant/backtest/engine.py#L41-L498)

## BacktestContext状态管理

```mermaid
classDiagram
class Context {
+current_date : date
+portfolio : Portfolio
+config : dict
+order(symbol, quantity, price) : str
+order_target(symbol, target_quantity, price) : str
+order_value(symbol, value, price) : str
+order_target_value(symbol, target_value, price) : str
+get_daily_basic(symbol, trade_date) : dict | None
}
class Portfolio {
+cash : float
+positions : dict[str, Position]
+total_value : float
+get_position(symbol) : Position
+update_position_value(symbol, price) : void
}
class Position {
+symbol : str
+quantity : float
+avg_cost : float
+current_price : float
+market_value : float
+profit : float
+profit_pct : float
}
Context --> Portfolio : "包含"
Portfolio --> Position : "包含"
```

**图示来源**  
- [context.py](file://zquant/backtest/context.py#L82-L188)

**本节来源**  
- [context.py](file://zquant/backtest/context.py#L82-L188)

## Order订单模拟机制

```mermaid
classDiagram
class Order {
+order_id : str
+symbol : str
+side : OrderSide
+quantity : float
+price : float | None
+status : OrderStatus
+filled_quantity : float
+filled_price : float
+commission : float
+tax : float
+slippage : float
+order_date : date
+fill_date : date | None
+reason : str | None
+is_buy : bool
+is_sell : bool
+is_filled : bool
+total_cost : float
}
class OrderStatus {
+PENDING : "pending"
+FILLED : "filled"
+CANCELLED : "cancelled"
+REJECTED : "rejected"
}
class OrderSide {
+BUY : "buy"
+SELL : "sell"
}
Order --> OrderStatus : "状态"
Order --> OrderSide : "方向"
```

**图示来源**  
- [order.py](file://zquant/backtest/order.py#L32-L86)

**本节来源**  
- [order.py](file://zquant/backtest/order.py#L32-L86)

## 交易成本计算

```mermaid
classDiagram
class CostCalculator {
+config : CostConfig
+calculate_commission(value) : float
+calculate_tax(value, is_sell) : float
+calculate_slippage(value) : float
+calculate_total_cost(quantity, price, is_sell) : tuple
+apply_costs_to_order(order, fill_price) : void
}
class CostConfig {
+commission_rate : float
+min_commission : float
+tax_rate : float
+slippage_rate : float
}
CostCalculator --> CostConfig : "配置"
```

**图示来源**  
- [cost.py](file://zquant/backtest/cost.py#L33-L116)

**本节来源**  
- [cost.py](file://zquant/backtest/cost.py#L33-L116)

## 绩效指标生成

```mermaid
classDiagram
class PerformanceAnalyzer {
+engine : BacktestEngine
+benchmark_data : dict[date, float]
+calculate_metrics() : dict[str, Any]
+_get_nav_series() : pd.Series
+_calculate_returns(nav_series) : pd.Series
+_calculate_total_return(nav_series) : float
+_calculate_annual_return(returns) : float
+_calculate_max_drawdown(nav_series) : float
+_calculate_volatility(returns) : float
+_calculate_sharpe_ratio(returns) : float
+_calculate_alpha(returns, benchmark_returns) : float
+_calculate_beta(returns, benchmark_returns) : float
+_calculate_win_rate() : float
+_calculate_profit_loss_ratio() : float
+_group_trades() : list[dict[str, Any]]
}
PerformanceAnalyzer --> BacktestEngine : "依赖"
```

**图示来源**  
- [performance.py](file://zquant/backtest/performance.py#L36-L330)

**本节来源**  
- [performance.py](file://zquant/backtest/performance.py#L36-L330)

## 策略接口与实现

```mermaid
classDiagram
class BaseStrategy {
+context : Context
+params : dict[str, Any]
+initialize() : void
+on_bar(context, bar_data) : void
+on_tick(context, tick_data) : void
+on_order_status(context, order) : void
}
class Strategy {
+initialize() : void
+on_bar(context, bar_data) : void
}
BaseStrategy <|-- Strategy : "继承"
```

**图示来源**  
- [strategy.py](file://zquant/backtest/strategy.py#L33-L82)

**本节来源**  
- [strategy.py](file://zquant/backtest/strategy.py#L33-L82)

## 策略代码示例

```mermaid
flowchart TD
Start([策略初始化]) --> SetParams["设置参数: short_window=5, long_window=20"]
SetParams --> InitHistory["初始化历史价格数据字典"]
InitHistory --> OnBarLoop["进入on_bar循环"]
subgraph OnBar循环
OnBarLoop --> AddPrice["添加当前收盘价到历史数据"]
AddPrice --> KeepLength["保持历史数据长度不超过long_window"]
KeepLength --> CheckLength{"历史数据长度 >= long_window?"}
CheckLength --> |否| ContinueLoop
CheckLength --> |是| CalculateMA["计算短期和长期均线"]
CalculateMA --> GetPosition["获取当前持仓"]
GetPosition --> CheckSignal{"短期均线上穿长期均线?"}
CheckSignal --> |是且无持仓| Buy["买入: 使用总资产30%"]
CheckSignal --> |否| CheckSellSignal{"短期均线下穿长期均线?"}
CheckSellSignal --> |是且有持仓| Sell["卖出: 清仓"]
CheckSellSignal --> |否| ContinueLoop
Buy --> ContinueLoop
Sell --> ContinueLoop
end
ContinueLoop --> EndLoop["继续下一个交易日"]
EndLoop --> OnBarLoop
```

**图示来源**  
- [simple_ma.py](file://zquant/strategy/examples/simple_ma.py#L12-L59)

**本节来源**  
- [simple_ma.py](file://zquant/strategy/examples/simple_ma.py#L12-L59)
- [dual_ma.py](file://zquant/strategy/examples/dual_ma.py#L27-L99)
- [rsi_strategy.py](file://zquant/strategy/examples/rsi_strategy.py#L24-L93)

## 数据服务集成

```mermaid
sequenceDiagram
participant 回测引擎 as BacktestEngine
participant 价格数据仓库 as PriceDataRepository
participant 交易日历仓库 as TradingDateRepository
participant 数据库 as Database
回测引擎->>交易日历仓库 : get_trading_dates(start, end)
交易日历仓库->>数据库 : 查询交易日历
数据库-->>交易日历仓库 : 返回交易日列表
交易日历仓库-->>回测引擎 : 返回交易日列表
回测引擎->>价格数据仓库 : batch_get_daily_data(symbols, start, end)
价格数据仓库->>数据库 : 批量查询日线数据
数据库-->>价格数据仓库 : 返回批量数据
价格数据仓库-->>回测引擎 : 返回价格数据
回测引擎->>价格数据仓库 : batch_get_daily_basic_data(symbols, start, end)
价格数据仓库->>数据库 : 批量查询每日指标数据
数据库-->>价格数据仓库 : 返回批量数据
价格数据仓库-->>回测引擎 : 返回每日指标数据
```

**图示来源**  
- [engine.py](file://zquant/backtest/engine.py#L83-L138)
- [engine.py](file://zquant/backtest/engine.py#L140-L181)

**本节来源**  
- [engine.py](file://zquant/backtest/engine.py#L83-L181)

## 前端数据交互

```mermaid
sequenceDiagram
participant 前端页面 as BacktestCreatePage
participant 前端服务 as BacktestService
participant 后端API as BacktestAPI
participant 回测服务 as BacktestService
participant 回测引擎 as BacktestEngine
前端页面->>前端服务 : runBacktest(request)
前端服务->>后端API : POST /api/v1/backtest/run
后端API->>回测服务 : create_task(...)
回测服务->>数据库 : 保存回测任务
数据库-->>回测服务 : 返回任务ID
回端API-->>前端服务 : 返回任务响应
前端服务-->>前端页面 : 创建成功
后端API->>回测服务 : run_backtest(task_id)
回测服务->>回测引擎 : 创建引擎并运行
回测引擎->>回测引擎 : 执行回测循环
回测引擎-->>回测服务 : 返回回测结果
回测服务->>数据库 : 保存回测结果
数据库-->>回测服务 : 返回结果
回测服务-->>后端API : 返回结果
后端API-->>前端服务 : 返回结果
前端服务-->>前端页面 : 显示结果
```

**图示来源**  
- [create.tsx](file://web/src/pages/backtest/create.tsx#L161-L189)
- [backtest.ts](file://web/src/services/zquant/backtest.ts#L31-L39)
- [backtest.py](file://zquant/api/v1/backtest.py#L90-L116)
- [backtest.py](file://zquant/services/backtest.py#L101-L154)

**本节来源**  
- [create.tsx](file://web/src/pages/backtest/create.tsx#L161-L189)
- [backtest.ts](file://web/src/services/zquant/backtest.ts#L31-L39)
- [backtest.py](file://zquant/api/v1/backtest.py#L90-L116)
- [backtest.py](file://zquant/services/backtest.py#L101-L154)

## 性能优化策略

```mermaid
flowchart TD
A[性能优化策略] --> B[批量数据查询]
A --> C[向量化计算]
A --> D[内存管理]
A --> E[索引优化]
B --> B1["使用batch_get_daily_data批量加载所有股票数据"]
B --> B2["减少数据库查询次数"]
B --> B3["使用Repository模式优化数据访问"]
C --> C1["使用pandas进行向量化计算"]
C --> C2["避免Python循环进行数值计算"]
C --> C3["利用numpy的高效数学函数"]
D --> D1["及时清理不再需要的数据"]
D --> D2["使用生成器处理大数据集"]
D --> D3["避免在循环中创建大量临时对象"]
E --> E1["为关键字段创建数据库索引"]
E --> E2["在zq_backtest_tasks表上为user_id和status创建索引"]
E --> E3["在zq_backtest_results表上为task_id创建唯一索引"]
```

**本节来源**  
- [engine.py](file://zquant/backtest/engine.py#L110-L114)
- [engine.py](file://zquant/backtest/engine.py#L145-L148)
- [backtest.py](file://zquant/models/backtest.py#L54-L60)
- [backtest.py](file://zquant/models/backtest.py#L98-L99)

## 常见问题排查

```mermaid
flowchart TD
A[常见问题] --> B[滑点模拟不准]
A --> C[资金曲线异常]
A --> D[回测结果不一致]
A --> E[策略不执行]
B --> B1["检查slippage_rate配置值"]
B --> B2["确认滑点是在成交价格上应用"]
B --> B3["验证滑点计算是否包含在总成本中"]
C --> C1["检查佣金、印花税计算逻辑"]
C --> C2["验证资金更新是否在正确时机执行"]
C --> C3["确认持仓市值更新频率"]
C --> C4["检查订单成交时的资金扣除逻辑"]
D --> D1["确保使用相同的随机种子"]
D --> D2["验证数据源是否一致"]
D --> D3["检查策略参数是否完全相同"]
D --> D4["确认交易日历是否一致"]
E --> E1["检查策略初始化是否成功"]
E --> E2["验证on_bar方法是否被调用"]
E --> E3["确认股票代码是否在股票池中"]
E --> E4["检查交易日期是否在回测范围内"]
```

**本节来源**  
- [cost.py](file://zquant/backtest/cost.py#L77-L87)
- [engine.py](file://zquant/backtest/engine.py#L327-L329)
- [engine.py](file://zquant/backtest/engine.py#L385-L391)
- [engine.py](file://zquant/backtest/engine.py#L397-L404)
- [engine.py](file://zquant/backtest/engine.py#L207-L209)
- [engine.py](file://zquant/backtest/engine.py#L421-L449)

## 结论
zquant回测引擎通过模块化设计实现了完整的量化策略回测功能。引擎核心由BacktestEngine类驱动，通过事件循环处理每日K线数据并调用用户策略的on_bar方法。BacktestContext类管理回测过程中的所有状态，包括投资组合、持仓和时间推进。Order类模拟了限价单和市价单的交易行为，支持T+1延迟成交机制。交易成本计算模块精确模拟了佣金、印花税和滑点等交易费用。绩效分析器提供了全面的绩效指标，包括收益率、风险指标和交易统计。用户策略通过继承BaseStrategy类并实现on_bar等回调方法来定义交易逻辑。系统与数据服务层集成，通过Repository模式高效获取历史行情数据。前端通过API与后端交互，实现了回测任务的创建、管理和结果展示。整体架构清晰，性能优化充分，为量化策略开发提供了可靠的回测支持。