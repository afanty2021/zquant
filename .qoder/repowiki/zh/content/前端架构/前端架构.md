# 前端架构

<cite>
**本文档引用的文件**
- [app.tsx](file://web/src/app.tsx)
- [routes.ts](file://web/config/routes.ts)
- [access.ts](file://web/src/access.ts)
- [index.ts](file://web/src/services/zquant/index.ts)
- [auth.ts](file://web/src/services/zquant/auth.ts)
- [users.ts](file://web/src/services/zquant/users.ts)
- [DataTable](file://web/src/components/DataTable/index.tsx)
- [GlobalTabs](file://web/src/components/GlobalTabs/index.tsx)
- [useGlobalTabs.ts](file://web/src/hooks/useGlobalTabs.ts)
- [GlobalTabsProvider](file://web/src/components/GlobalTabsProvider/index.tsx)
- [roles.ts](file://web/src/constants/roles.ts)
- [routeMatcher.ts](file://web/src/utils/routeMatcher.ts)
- [api.ts](file://web/config/api.ts)
- [requestErrorConfig.ts](file://web/src/requestErrorConfig.ts)
- [en-US.ts](file://web/src/locales/en-US.ts)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [路由配置](#路由配置)
3. [状态管理机制](#状态管理机制)
4. [API客户端封装](#api客户端封装)
5. [多语言支持](#多语言支持)
6. [权限控制](#权限控制)
7. [UI组件设计](#ui组件设计)
8. [性能优化建议](#性能优化建议)

## 项目结构

zquant前端项目采用UmiJS框架构建，项目结构清晰，遵循模块化设计原则。核心目录包括config、src、mock等，其中src目录包含components、pages、services等关键模块。

```mermaid
graph TB
web[web/] --> config[config/]
web --> src[src/]
web --> mock[mock/]
web --> public[public/]
src --> components[components/]
src --> pages[pages/]
src --> services[services/]
src --> locales[locales/]
src --> hooks[hooks/]
src --> constants[constants/]
src --> utils[utils/]
components --> DataTable[DataTable/]
components --> GlobalTabs[GlobalTabs/]
components --> GlobalTabsProvider[GlobalTabsProvider/]
services --> zquant[zquant/]
services --> ant-design-pro[ant-design-pro/]
services --> swagger[swagger/]
locales --> zh-CN[zh-CN/]
locales --> en-US[en-US/]
locales --> ja-JP[ja-JP/]
```

**图表来源**
- [app.tsx](file://web/src/app.tsx)
- [routes.ts](file://web/config/routes.ts)

**本节来源**
- [app.tsx](file://web/src/app.tsx)
- [routes.ts](file://web/config/routes.ts)

## 路由配置

基于UmiJS的路由配置系统，zquant实现了清晰的路由结构。路由配置文件`routes.ts`定义了应用的导航结构，支持嵌套路由、重定向和权限控制。

路由配置的主要特点包括：
- **模块化组织**：按功能模块（如用户、账户、回测、数据等）组织路由
- **权限集成**：通过`access`字段与权限系统集成
- **菜单支持**：通过`name`和`icon`字段支持菜单显示
- **动态路由**：支持参数化路由（如`/backtest/detail/:id`）

```mermaid
graph TD
Root[/] --> Welcome[欢迎页]
Root --> User[用户]
Root --> Account[账户]
Root --> Dashboard[系统大盘]
Root --> Watchlist[我的关注]
Root --> Factor[因子管理]
Root --> Backtest[回测]
Root --> Data[数据源]
Root --> Admin[系统设置]
User --> Login[登录]
User --> ApiKeys[API密钥]
Account --> Center[个人中心]
Account --> Settings[个人设置]
Watchlist --> MyWatchlist[我的自选股]
Watchlist --> MyPositions[我的持仓]
Watchlist --> QuickAccess[快速访问]
Factor --> Definitions[因子定义]
Factor --> Models[因子模型]
Factor --> Configs[因子配置]
Factor --> Results[因子结果]
Backtest --> List[回测列表]
Backtest --> Strategies[策略管理]
Backtest --> Create[创建回测]
Backtest --> Detail[回测详情]
Backtest --> Performance[性能分析]
```

**图表来源**
- [routes.ts](file://web/config/routes.ts)

**本节来源**
- [routes.ts](file://web/config/routes.ts)

## 状态管理机制

zquant前端采用UmiJS的`getInitialState`和`layout`配置实现状态管理，结合React Context和自定义Hook，实现了全局状态与页面局部状态的有效分离。

### 全局状态管理

全局状态主要通过`app.tsx`中的`getInitialState`函数管理，包括：
- **用户信息**：存储当前用户信息，包括用户名、角色、权限等
- **应用设置**：存储UI主题、布局等设置
- **加载状态**：管理应用初始化加载状态

```mermaid
classDiagram
class User {
+string name
+string avatar
+string userid
+string email
+string access
+number role_id
}
class LayoutSettings {
+string navTheme
+string layout
+string contentWidth
+string fixedHeader
+string fixSiderbar
+string primaryColor
+string title
+string pwa
}
class InitialState {
+Partial~LayoutSettings~ settings
+User currentUser
+boolean loading
+function fetchUserInfo()
}
InitialState --> User : "包含"
InitialState --> LayoutSettings : "包含"
```

**图表来源**
- [app.tsx](file://web/src/app.tsx)

**本节来源**
- [app.tsx](file://web/src/app.tsx)

### 页面局部状态

页面局部状态通过React组件自身的state和自定义Hook管理。例如，`GlobalTabs`组件使用`useGlobalTabs` Hook管理标签页状态。

```mermaid
sequenceDiagram
participant Component as "页面组件"
participant Hook as "自定义Hook"
participant Context as "Context"
Component->>Hook : 调用Hook
Hook->>Hook : 初始化状态
Hook->>Context : 提供状态
Component->>Component : 使用状态
Component->>Hook : 触发状态更新
Hook->>Hook : 更新状态
Hook->>Context : 通知状态变更
Context->>Component : 重新渲染
```

**图表来源**
- [useGlobalTabs.ts](file://web/src/hooks/useGlobalTabs.ts)
- [GlobalTabsProvider](file://web/src/components/GlobalTabsProvider/index.tsx)

**本节来源**
- [app.tsx](file://web/src/app.tsx)
- [useGlobalTabs.ts](file://web/src/hooks/useGlobalTabs.ts)

## API客户端封装

API客户端封装位于`services/zquant/`目录下，实现了统一的请求处理、认证和错误响应机制。

### 请求封装结构

```mermaid
graph TD
Request[请求] --> Interceptor[请求拦截器]
Interceptor --> Auth[认证处理]
Auth --> API[API调用]
API --> Response[响应]
Response --> Error[错误处理]
Error --> Notification[通知]
subgraph "services/zquant"
auth[auth.ts]
users[users.ts]
data[data.ts]
backtest[backtest.ts]
factor[factor.ts]
end
requestErrorConfig[requestErrorConfig.ts] --> Interceptor
requestErrorConfig --> Error
```

**图表来源**
- [auth.ts](file://web/src/services/zquant/auth.ts)
- [users.ts](file://web/src/services/zquant/users.ts)
- [requestErrorConfig.ts](file://web/src/requestErrorConfig.ts)

### 认证机制

认证机制通过请求拦截器自动添加JWT Token到请求头：

```mermaid
sequenceDiagram
participant Frontend as "前端"
participant Backend as "后端"
Frontend->>Frontend : 用户登录
Frontend->>Backend : POST /api/v1/auth/login
Backend-->>Frontend : 返回Token
Frontend->>Frontend : 存储Token到localStorage
loop 每次API请求
Frontend->>Frontend : 请求拦截器
Frontend->>Frontend : 读取Token
Frontend->>Backend : 添加Authorization头
Backend->>Backend : 验证Token
Backend-->>Frontend : 返回数据
end
Frontend->>Backend : Token过期(401)
Backend-->>Frontend : 401 Unauthorized
Frontend->>Frontend : 清除Token
Frontend->>Frontend : 跳转登录页
```

**图表来源**
- [auth.ts](file://web/src/services/zquant/auth.ts)
- [requestErrorConfig.ts](file://web/src/requestErrorConfig.ts)

### 错误处理

错误处理配置在`requestErrorConfig.ts`中，支持多种错误显示类型：

```mermaid
flowchart TD
Start([开始]) --> CheckResponse["检查响应状态"]
CheckResponse --> IsSuccess{"成功?"}
IsSuccess --> |是| ReturnData["返回数据"]
IsSuccess --> |否| CheckErrorType["检查错误类型"]
CheckErrorType --> IsBizError{"业务错误?"}
IsBizError --> |是| HandleBizError["处理业务错误"]
IsBizError --> |否| IsNetworkError{"网络错误?"}
IsNetworkError --> |是| HandleNetworkError["处理网络错误"]
IsNetworkError --> |否| IsRequestError{"请求错误?"}
IsRequestError --> |是| HandleRequestError["处理请求错误"]
IsRequestError --> |否| HandleUnknownError["处理未知错误"]
HandleBizError --> ShowMessage["显示错误消息"]
HandleNetworkError --> ShowNetworkError["显示网络错误"]
HandleRequestError --> ShowRequestError["显示请求错误"]
HandleUnknownError --> LogError["记录错误"]
ReturnData --> End([结束])
ShowMessage --> End
ShowNetworkError --> End
ShowRequestError --> End
LogError --> End
```

**图表来源**
- [requestErrorConfig.ts](file://web/src/requestErrorConfig.ts)

**本节来源**
- [index.ts](file://web/src/services/zquant/index.ts)
- [auth.ts](file://web/src/services/zquant/auth.ts)
- [users.ts](file://web/src/services/zquant/users.ts)
- [requestErrorConfig.ts](file://web/src/requestErrorConfig.ts)

## 多语言支持

多语言支持通过`locales/`目录实现，支持多种语言（中文、英文、日文等），采用UmiJS的国际化方案。

### 多语言结构

```mermaid
graph TD
Locales[locales/] --> zh-CN[zh-CN/]
Locales --> en-US[en-US/]
Locales --> ja-JP[ja-JP/]
Locales --> id-ID[id-ID/]
Locales --> pt-BR[pt-BR/]
Locales --> fa-IR[fa-IR/]
Locales --> bn-BD[bn-BD/]
zh-CN --> component[component.ts]
zh-CN --> globalHeader[globalHeader.ts]
zh-CN --> menu[menu.ts]
zh-CN --> pages[pages.ts]
zh-CN --> pwa[pwa.ts]
zh-CN --> settingDrawer[settingDrawer.ts]
zh-CN --> settings[settings.ts]
en-US --> component[component.ts]
en-US --> globalHeader[globalHeader.ts]
en-US --> menu[menu.ts]
en-US --> pages[pages.ts]
en-US --> pwa[pwa.ts]
en-US --> settingDrawer[settingDrawer.ts]
en-US --> settings[settings.ts]
```

**图表来源**
- [en-US.ts](file://web/src/locales/en-US.ts)

### 多语言实现机制

```mermaid
sequenceDiagram
participant Component as "组件"
participant Intl as "国际化API"
participant Locale as "语言包"
Component->>Intl : 调用formatMessage
Intl->>Locale : 查找对应语言的文本
Locale-->>Intl : 返回文本
Intl-->>Component : 返回格式化文本
Component->>Component : 显示文本
Note over Component,Intl : 支持动态切换语言
```

**本节来源**
- [en-US.ts](file://web/src/locales/en-US.ts)

## 权限控制

权限控制通过`access.ts`文件实现，基于用户角色和权限进行访问控制。

### 权限控制流程

```mermaid
sequenceDiagram
participant Layout as "布局组件"
participant Access as "权限系统"
participant User as "用户"
Layout->>Access : 请求权限检查
Access->>User : 获取用户信息
User-->>Access : 返回用户角色
Access->>Access : 判断权限
Access-->>Layout : 返回权限结果
Layout->>Layout : 根据权限显示/隐藏菜单
```

### 权限配置

```mermaid
classDiagram
class Roles {
+number ADMIN_ROLE_ID = 1
+number RESEARCHER_ROLE_ID = 2
+number USER_ROLE_ID = 3
}
class Permissions {
+boolean canAdmin
+boolean canResearcher
+boolean canUser
+boolean canAccessData
+boolean canAccessBacktest
+boolean canAccessFactor
+boolean canAccessWatchlist
+boolean canAccessApiKeys
}
class Access {
+function access(initialState)
+Roles roles
+Permissions permissions
}
Access --> Roles : "使用"
Access --> Permissions : "返回"
```

**图表来源**
- [access.ts](file://web/src/access.ts)
- [roles.ts](file://web/src/constants/roles.ts)

**本节来源**
- [access.ts](file://web/src/access.ts)
- [roles.ts](file://web/src/constants/roles.ts)

## UI组件设计

### DataTable组件

`DataTable`组件是基于Ant Design Pro的`ProTable`封装的通用数据表格组件，提供统一的数据展示和格式化功能。

```mermaid
classDiagram
class DataTable {
+ProColumns~T~ columns
+T[] dataSource
+boolean loading
+number scrollX
+number pageSize
+function DataTable()
}
class Renderers {
+function renderDate(text)
+function renderDateTime(text)
+function renderNumber(text, decimals)
+function renderPercent(text, decimals)
+function renderFormattedNumber(text)
+function renderChange(text, isPercent, decimals)
}
DataTable --> Renderers : "使用"
DataTable --> ProTable : "包装"
```

**图表来源**
- [DataTable](file://web/src/components/DataTable/index.tsx)

### GlobalTabs组件

`GlobalTabs`组件实现多标签页功能，支持页卡的添加、关闭和切换。

```mermaid
classDiagram
class TabItem {
+string key
+string title
+string path
+boolean closable
}
class GlobalTabs {
+TabItem[] tabs
+string activeKey
+function addTab(tab)
+function removeTab(key)
+function changeTab(key)
}
class GlobalTabsProvider {
+GlobalTabsContext context
+function useGlobalTabsContext()
}
GlobalTabsProvider --> GlobalTabs : "包含"
GlobalTabsProvider --> GlobalTabsContext : "提供"
GlobalTabsContext --> TabItem : "包含"
```

**图表来源**
- [GlobalTabs](file://web/src/components/GlobalTabs/index.tsx)
- [useGlobalTabs.ts](file://web/src/hooks/useGlobalTabs.ts)
- [GlobalTabsProvider](file://web/src/components/GlobalTabsProvider/index.tsx)

**本节来源**
- [DataTable](file://web/src/components/DataTable/index.tsx)
- [GlobalTabs](file://web/src/components/GlobalTabs/index.tsx)
- [useGlobalTabs.ts](file://web/src/hooks/useGlobalTabs.ts)

## 性能优化建议

### 懒加载与代码分割

建议对大型页面组件实施懒加载和代码分割：

```mermaid
flowchart TD
Start([应用启动]) --> LoadCore["加载核心代码"]
LoadCore --> ShowLoading["显示加载界面"]
ShowLoading --> LoadPage["按需加载页面代码"]
LoadPage --> RenderPage["渲染页面"]
RenderPage --> End([完成])
Note over LoadCore,LoadPage: 减少初始加载时间
```

### 请求缓存

实现请求缓存机制，避免重复请求：

```mermaid
flowchart TD
Request([请求数据]) --> CheckCache["检查缓存"]
CheckCache --> CacheHit{"缓存命中?"}
CacheHit --> |是| ReturnCache["返回缓存数据"]
CacheHit --> |否| CallAPI["调用API"]
CallAPI --> StoreCache["存储到缓存"]
StoreCache --> ReturnData["返回数据"]
ReturnCache --> End([结束])
ReturnData --> End
```

### 其他优化建议

1. **组件懒加载**：对非关键组件使用React.lazy
2. **数据分页**：大数据量使用分页加载
3. **虚拟滚动**：长列表使用虚拟滚动
4. **防抖节流**：频繁操作使用防抖节流
5. **资源压缩**：生产环境启用代码压缩

**本节来源**
- [app.tsx](file://web/src/app.tsx)
- [DataTable](file://web/src/components/DataTable/index.tsx)