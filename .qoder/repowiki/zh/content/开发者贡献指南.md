# 开发者贡献指南

<cite>
**本文档引用的文件**   
- [CONTRIBUTING.md](file://CONTRIBUTING.md)
- [docs/code_formatting.md](file://docs/code_formatting.md)
- [.pre-commit-config.yaml](file://.pre-commit-config.yaml)
- [web/biome.json](file://web/biome.json)
- [zquant/pyproject.toml](file://zquant/pyproject.toml)
- [zquant/requirements.txt](file://zquant/requirements.txt)
- [zquant/.format.sh](file://zquant/.format.sh)
- [zquant/.format.bat](file://zquant/.format.bat)
- [web/package.json](file://web/package.json)
- [web/.lintstagedrc](file://web/.lintstagedrc)
- [zquant/tests/conftest.py](file://zquant/tests/conftest.py)
- [zquant/tests/unittest/test_auth_service.py](file://zquant/tests/unittest/test_auth_service.py)
- [zquant/tests/unittest/base.py](file://zquant/tests/unittest/base.py)
- [web/jest.config.ts](file://web/jest.config.ts)
</cite>

## 目录
1. [贡献流程](#贡献流程)
2. [代码规范](#代码规范)
3. [测试与验证](#测试与验证)
4. [调试技巧与最佳实践](#调试技巧与最佳实践)

## 贡献流程

本节详细说明如何向 ZQuant 项目贡献代码，包括提交 Issue 和 Pull Request 的完整流程。

### 提交 Issue

在提交 Issue 前，请先在 [Issues](https://github.com/yoyoung/zquant/issues) 中搜索，确认问题尚未被报告。根据问题类型，提供相应信息：

- **报告 Bug**：提供清晰的标题和描述、复现步骤、预期行为和实际行为、环境信息（Python 版本、操作系统等）以及错误日志。
- **功能请求**：说明功能描述和使用场景、该功能对项目的价值，以及可能的实现方案（可选）。
- **文档改进**：可修正拼写错误、改进文档结构、添加使用示例或进行翻译。

### 开发环境设置

在开始贡献代码前，需要设置开发环境：

1. **Fork 和克隆仓库**
   ```bash
   git clone https://github.com/YOUR_USERNAME/zquant.git
   cd zquant
   git remote add upstream https://github.com/yoyoung/zquant.git
   ```

2. **创建虚拟环境**
   ```bash
   python -m venv venv
   # Windows
   venv\Scripts\activate
   # Linux/Mac
   source venv/bin/activate
   ```

3. **安装依赖**
   ```bash
   pip install -r requirements.txt
   ```

4. **配置环境变量**
   ```bash
   cp .env.example .env
   # 编辑 .env 文件，配置数据库、Redis等
   ```

5. **初始化数据库**
   ```bash
   # 创建数据库
   mysql -u root -p -e "CREATE DATABASE zquant CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
   # 运行迁移
   alembic upgrade head
   ```

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L55-L105)

### 提交代码流程

遵循以下步骤提交代码：

1. **创建功能分支**
   ```bash
   git checkout main
   git pull upstream main
   git checkout -b feature/your-feature-name
   ```

2. **进行更改**
   - 编写代码
   - 添加测试
   - 更新文档
   - 确保代码通过所有检查

3. **提交更改**
   ```bash
   git add .
   git commit -m "feat(backtest): 添加策略管理功能"
   ```

4. **保持分支同步**
   ```bash
   git fetch upstream
   git rebase upstream/main
   ```

5. **推送更改**
   ```bash
   git push origin feature/your-feature-name
   ```

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L203-L249)

### Pull Request 流程

创建 Pull Request 的完整流程如下：

1. **创建 Pull Request**
   - 在 GitHub 上打开您的 Fork
   - 点击 "New Pull Request"
   - 选择您的分支和目标分支（通常是 `main`）
   - 填写 PR 描述，包括更改的目的和背景、实现方式、测试情况和相关 Issue（如果有）

2. **PR 检查清单**
   在提交 PR 前，请确认：
   - [ ] 代码遵循项目代码规范
   - [ ] 所有测试通过
   - [ ] 添加了必要的测试用例
   - [ ] 更新了相关文档
   - [ ] 提交信息清晰明确
   - [ ] 没有合并冲突
   - [ ] 代码已通过 lint 检查

3. **代码审查**
   - 维护者会审查您的 PR
   - 可能会要求修改或提供更多信息
   - 请及时响应审查意见

4. **合并**
   - 审查通过后，维护者会合并您的 PR
   - 合并后，您的贡献将出现在项目历史中

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L252-L286)

## 代码规范

本节详细描述项目的代码风格要求，包括前端和后端的格式化工具配置。

### 前端代码规范

前端使用 Biome 进行 TypeScript 格式化，配置文件为 `web/biome.json`。

- **格式化工具**: Biome
- **配置文件**: `web/biome.json`
- **主要配置**:
  - 缩进风格: 空格
  - 引号风格: 单引号
  - 忽略的文件: `.umi/**`, `.umi-production/**`, `src/services/**`, `mock/**`, `dist/**`, `node_modules/**` 等

Biome 的配置通过 `.lintstagedrc` 文件在提交时自动执行：
```json
{
  "**/*.{js,jsx,tsx,ts,md,css,less,json}": [
    "npx @biomejs/biome check --write"
  ]
}
```

**Section sources**
- [web/biome.json](file://web/biome.json)
- [web/.lintstagedrc](file://web/.lintstagedrc)

### 后端代码规范

后端使用 Ruff、Black 和 isort 进行 Python 代码格式化，通过 `.pre-commit-config.yaml` 实现提交时自动检查。

- **主要工具**:
  - **Ruff**: 极快的 Python linter 和代码格式化工具（推荐）
  - **Black**: 代码格式化工具
  - **isort**: 导入排序工具

- **配置文件**:
  - `pyproject.toml`: 包含 Ruff、Black 和 isort 的详细配置
  - `.pre-commit-config.yaml`: 配置 pre-commit hooks

- **核心配置**:
  - 行长度: 120 字符
  - 目标 Python 版本: py311
  - 引号风格: 双引号（Ruff）/ 双引号（Black）
  - 导入排序: 使用 black 风格

`.pre-commit-config.yaml` 配置了在提交时自动运行 Ruff 进行代码检查和格式化：
```yaml
repos:
  - repo: local
    hooks:
      - id: ruff
        name: ruff (lint)
        entry: python -m ruff check --fix
        language: system
        types_or: [python, pyi]
        pass_filenames: true
        args: [--exit-non-zero-on-fix]
      - id: ruff-format
        name: ruff (format)
        entry: python -m ruff format
        language: system
        types_or: [python, pyi]
        pass_filenames: true
```

**Section sources**
- [docs/code_formatting.md](file://docs/code_formatting.md)
- [.pre-commit-config.yaml](file://.pre-commit-config.yaml)
- [zquant/pyproject.toml](file://zquant/pyproject.toml)

### 提交信息规范

提交信息应遵循以下格式：
```
<type>(<scope>): <subject>

<body>

<footer>
```

**类型 (Type)**:
- `feat`: 新功能
- `fix`: Bug修复
- `docs`: 文档更新
- `style`: 代码格式（不影响代码运行）
- `refactor`: 重构
- `test`: 测试相关
- `chore`: 构建过程或辅助工具的变动

**示例**:
```
feat(backtest): 添加策略管理功能

- 实现策略增删改查API
- 添加策略模板库
- 支持从策略库选择策略进行回测

Closes #123
```

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L171-L201)

## 测试与验证

本节指导开发者如何运行测试、执行静态检查和本地验证。

### 运行测试

项目使用 pytest 进行测试，配置文件为 `zquant/pyproject.toml`。

- **运行所有测试**:
  ```bash
  pytest
  ```

- **运行测试并生成覆盖率报告**:
  ```bash
  pytest --cov=zquant --cov-report=html
  ```

- **测试配置**:
  - 测试路径: `zquant/tests`
  - Python 文件模式: `test_*.py`
  - Python 类模式: `Test*`
  - Python 函数模式: `test_*`

测试使用 `conftest.py` 文件配置测试环境，包括数据库会话、测试客户端和测试用户等 fixture。

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L107-L115)
- [zquant/pyproject.toml](file://zquant/pyproject.toml#L181-L188)
- [zquant/tests/conftest.py](file://zquant/tests/conftest.py)

### 静态检查与代码格式化

项目提供了多种方式进行静态检查和代码格式化：

1. **使用便捷脚本**:
   - Linux/Mac:
     ```bash
     bash .format.sh check   # 检查代码
     bash .format.sh fix     # 自动修复并格式化
     bash .format.sh format  # 仅格式化（默认）
     bash .format.sh all     # 完整流程
     ```
   - Windows:
     ```cmd
     .format.bat check   # 检查代码
     .format.bat fix     # 自动修复并格式化
     .format.bat format  # 仅格式化（默认）
     .format.bat all     # 完整流程
     ```

2. **使用 Ruff（推荐）**:
   ```bash
   # 检查代码
   ruff check zquant/
   # 自动修复可修复的问题
   ruff check --fix zquant/
   # 格式化代码
   ruff format zquant/
   ```

3. **使用 Black + isort**:
   ```bash
   black zquant/
   isort zquant/
   ```

4. **使用 pre-commit**:
   ```bash
   # 安装 pre-commit
   pip install pre-commit
   # 安装 Git hooks
   pre-commit install
   # 手动运行所有检查
   pre-commit run --all-files
   ```

**Section sources**
- [docs/code_formatting.md](file://docs/code_formatting.md)
- [zquant/.format.sh](file://zquant/.format.sh)
- [zquant/.format.bat](file://zquant/.format.bat)

### 前端测试

前端使用 Jest 进行测试，配置文件为 `web/jest.config.ts`。

- **运行测试**:
  ```bash
  npm run test
  ```

- **生成覆盖率报告**:
  ```bash
  npm run test:coverage
  ```

- **更新快照**:
  ```bash
  npm run test:update
  ```

示例测试文件 `web/src/pages/user/login/login.test.tsx` 展示了如何使用 `@testing-library/react` 进行组件测试。

**Section sources**
- [web/package.json](file://web/package.json)
- [web/jest.config.ts](file://web/jest.config.ts)
- [web/src/pages/user/login/login.test.tsx](file://web/src/pages/user/login/login.test.tsx)

## 调试技巧与最佳实践

本节提供调试技巧和最佳实践，确保贡献代码的质量与一致性。

### 开发服务器

运行开发服务器以进行实时开发和调试：
```bash
uvicorn zquant.main:app --reload --host 0.0.0.0 --port 8000
```

API 文档可通过以下地址访问：
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L290-L300)

### 数据库迁移

管理数据库迁移的常用命令：
```bash
# 创建新迁移
alembic revision --autogenerate -m "描述"
# 应用迁移
alembic upgrade head
# 回滚迁移
alembic downgrade -1
```

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L302-L312)

### 调试技巧

1. **使用日志**: 项目使用 loguru 进行日志记录，可在代码中添加适当的日志语句进行调试。
2. **使用断点**: 在开发服务器中使用 `--reload` 参数，代码更改后会自动重启。
3. **检查网络请求**: 使用浏览器开发者工具检查 API 请求和响应。
4. **查看错误日志**: 检查服务器日志以获取详细的错误信息。

### 最佳实践

1. **编写测试**: 新功能应包含相应的测试用例，确保代码的正确性和稳定性。
2. **遵循代码规范**: 严格遵守项目的代码风格指南，使用提供的工具进行格式化和检查。
3. **保持提交原子性**: 每个提交应只包含一个逻辑更改，便于代码审查和问题追踪。
4. **及时同步主分支**: 定期从上游仓库拉取最新更改，避免合并冲突。
5. **清晰的提交信息**: 使用规范的提交信息格式，清晰描述更改内容。

**Section sources**
- [CONTRIBUTING.md](file://CONTRIBUTING.md#L288-L312)