# 数据校验接口

<cite>
**本文档引用的文件**   
- [data.py](file://zquant/api/v1/data.py)
- [data_utils.py](file://zquant/utils/data_utils.py)
- [data.py](file://zquant/schemas/data.py)
- [data.py](file://zquant/services/data.py)
- [tushare.py](file://zquant/data/etl/tushare.py)
</cite>

## 目录
1. [介绍](#介绍)
2. [核心功能与实现](#核心功能与实现)
3. [校验算法工作原理](#校验算法工作原理)
4. [数据对齐与差异检测](#数据对齐与差异检测)
5. [异常报告生成](#异常报告生成)
6. [辅助函数支持](#辅助函数支持)
7. [运维操作指南](#运维操作指南)
8. [结论](#结论)

## 介绍
本项目中的数据校验接口旨在确保系统数据库中存储的数据与Tushare原始API提供的数据保持一致。通过对比数据库记录和API返回的数据，该接口能够检测出数据差异、缺失或不一致的情况，并生成详细的校验报告，为数据质量审计提供支持。接口支持多种数据类型，包括日线数据、每日指标、技术因子和专业版因子等，覆盖了股票市场分析所需的核心数据。

## 核心功能与实现
数据校验接口的核心功能是通过`/api/v1/data/validate`端点实现的，该端点负责对比数据库存储数据与Tushare原始API数据的一致性。接口支持多种数据类型的校验，包括日线数据、每日指标、技术因子和专业版因子等。每种数据类型都有对应的校验端点，如`/daily/validate`、`/daily-basic/validate`、`/factor/validate`和`/stkfactorpro/validate`。这些端点接收包含股票代码、起止日期等参数的请求，然后从数据库和Tushare API获取相应数据进行对比。

**Section sources**
- [data.py](file://zquant/api/v1/data.py#L837-L1999)

## 校验算法工作原理
校验算法的工作原理主要包括以下几个步骤：首先，解析请求中的股票代码列表和日期范围；其次，初始化Tushare客户端以获取API数据；然后，从数据库和API获取指定股票和日期范围内的数据；接着，构建数据库记录和API记录的索引，以便进行高效的数据对齐；最后，遍历所有唯一的键，对比每条记录的字段值，识别出数据库缺失、API缺失或字段不一致的情况，并生成差异报告。

**Section sources**
- [data.py](file://zquant/api/v1/data.py#L837-L1999)

## 数据对齐与差异检测
数据对齐与差异检测是校验算法的关键环节。为了实现数据对齐，算法首先构建数据库记录和API记录的索引，索引的键由股票代码和交易日期组成。通过这种方式，可以快速定位到对应的记录进行对比。在差异检测方面，算法支持三种类型的差异：数据库缺失（即API有数据但数据库没有）、API缺失（即数据库有数据但API没有）和字段不一致（即数据库和API都有数据，但某些字段的值不同）。对于字段不一致的情况，算法会进一步分析具体是哪些字段存在差异，并记录下数据库值和API值。

**Section sources**
- [data.py](file://zquant/api/v1/data.py#L955-L1044)

## 异常报告生成
异常报告生成是校验过程的最后一步。当完成所有记录的对比后，算法会统计一致记录数、差异记录数以及失败的股票代码。然后，根据这些统计信息生成一个详细的校验报告，报告中包含校验结果的概要信息和详细的差异列表。差异列表中每条记录都包含了股票代码、交易日期、差异类型、字段差异详情以及数据库和API的原始记录。此外，报告还会按照交易日期倒序排列，以便用户优先查看最新的数据差异。

**Section sources**
- [data.py](file://zquant/api/v1/data.py#L1050-L1076)

## 辅助函数支持
`data_utils.py`文件中提供的辅助函数为数据校验操作提供了支持。其中，`clean_nan_values`函数用于清理对象中的NaN、Inf等无效数值，将其转换为None，确保数据可以正常进行JSON序列化。这对于处理从Tushare API获取的数据尤为重要，因为API返回的数据中可能包含NaN值。此外，`parse_date_field`函数用于解析日期字段，支持多种输入格式，如字符串、date对象、datetime对象或pandas Timestamp，提高了数据处理的灵活性。

**Section sources**
- [data_utils.py](file://zquant/utils/data_utils.py#L95-L119)

## 运维操作指南
运维人员可以使用数据校验接口进行数据质量审计。首先，确保Tushare Token已正确配置，这是调用Tushare API的前提条件。然后，通过调用相应的校验端点，如`/daily/validate`，传入需要校验的股票代码和日期范围。接口将返回一个包含校验结果的响应，其中包括一致记录数、差异记录数和详细的差异列表。运维人员可以根据这些信息判断数据质量，并对发现的问题进行调查和修复。建议定期执行数据校验，以确保数据的一致性和准确性。

**Section sources**
- [data.py](file://zquant/api/v1/data.py#L837-L1999)
- [tushare.py](file://zquant/data/etl/tushare.py#L39-L77)

## 结论
数据校验接口是确保系统数据质量的重要工具。通过对比数据库存储数据与Tushare原始API数据的一致性，该接口能够有效检测出数据差异、缺失或不一致的情况，并生成详细的校验报告。校验算法通过构建索引实现高效的数据对齐，并支持多种类型的差异检测。`data_utils.py`中的辅助函数为数据处理提供了便利，确保了数据的正确性和一致性。运维人员可以利用该接口进行定期的数据质量审计，及时发现并解决数据问题，从而保障系统的稳定运行和数据分析的准确性。