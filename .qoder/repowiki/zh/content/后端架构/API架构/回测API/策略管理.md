# 策略管理

<cite>
**本文档引用的文件**  
- [api_reference.md](file://docs/api/api_reference.md)
- [strategy_management.md](file://docs/strategy_management.md)
- [backtest.py](file://zquant/api/v1/backtest.py)
- [strategy.py](file://zquant/services/strategy.py)
- [backtest.py](file://zquant/models/backtest.py)
- [backtest.py](file://zquant/schemas/backtest.py)
- [init_strategies.py](file://zquant/scripts/init_strategies.py)
- [simple_ma.py](file://zquant/strategy/examples/simple_ma.py)
- [dual_ma.py](file://zquant/strategy/examples/dual_ma.py)
</cite>

## 目录

1. [简介](#简介)
2. [策略CRUD API](#策略crud-api)
3. [策略权限模型](#策略权限模型)
4. [策略参数模式（params_schema）](#策略参数模式params_schema)
5. [模板策略与共享机制](#模板策略与共享机制)
6. [策略代码结构规范与最佳实践](#策略代码结构规范与最佳实践)
7. [API请求/响应示例](#api请求响应示例)
8. [在回测中引用策略](#在回测中引用策略)

## 简介

本指南旨在为ZQuant平台的策略管理API提供一份权威、详尽的文档。它将深入解析策略的创建、读取、更新和删除（CRUD）操作，阐述策略权限控制、参数模式应用、模板共享机制，并提供策略代码的最佳实践。通过本文档，用户将能够全面掌握如何高效地使用策略管理系统进行量化策略的开发、管理和回测。

**Section sources**
- [strategy_management.md](file://docs/strategy_management.md#L1-L15)
- [api_reference.md](file://docs/api/api_reference.md#L1-L15)

## 策略CRUD API

策略管理API提供了对用户策略的完整生命周期管理。所有API端点均位于`/api/v1/backtest/strategies`路径下，并需要有效的JWT Token或API Key进行认证。

### 创建策略 (Create)

**端点**: `POST /api/v1/backtest/strategies`

此端点用于创建一个新的策略。请求体必须为JSON格式，包含策略的必要信息。

**请求体 (Request Body)**:
```json
{
  "name": "我的新策略",
  "code": "from zquant.backtest.strategy import BaseStrategy\n\nclass Strategy(BaseStrategy):\n    def initialize(self):\n        pass\n\n    def on_bar(self, context, bar_data):\n        pass",
  "description": "一个简单的示例策略",
  "category": "technical",
  "params_schema": "{\"window\": {\"type\": \"integer\", \"default\": 20}}",
  "is_template": false
}
```

**字段说明**:
- `name` (string, 必填): 策略的名称。
- `code` (string, 必填): 策略的Python代码。
- `description` (string, 可选): 策略的描述。
- `category` (string, 可选): 策略的分类，如 `technical` (技术分析), `fundamental` (基本面分析), `quantitative` (量化策略)。
- `params_schema` (string, 可选): 一个JSON字符串，定义了策略参数的结构，用于前端动态生成配置表单。
- `is_template` (boolean, 可选, 默认 `false`): 是否将此策略标记为模板策略。只有管理员或创建者可以创建或修改模板。

**响应**: 成功时返回 `201 Created` 状态码，并返回创建的策略对象。

**Section sources**
- [backtest.py](file://zquant/api/v1/backtest.py#L231-L249)
- [strategy_management.md](file://docs/strategy_management.md#L60-L75)

### 获取策略列表 (Read - List)

**端点**: `GET /api/v1/backtest/strategies`

此端点用于获取策略列表，支持多种筛选和排序选项。

**查询参数 (Query Parameters)**:
- `skip` (integer, 默认 0): 跳过的记录数，用于分页。
- `limit` (integer, 默认 100, 最大 1000): 返回的记录数，用于分页。
- `category` (string, 可选): 按分类筛选策略。
- `search` (string, 可选): 按策略名称或描述进行关键词搜索。
- `is_template` (boolean, 可选): 筛选是否为模板策略。
- `order_by` (string, 可选): 指定排序字段，可选值包括 `id`, `name`, `category`, `created_at`, `updated_at`。
- `order` (string, 默认 `desc`): 排序方向，`asc` (升序) 或 `desc` (降序)。
- `include_all` (boolean, 默认 `false`): 如果为 `true`，则返回所有可操作的策略，包括用户自己的策略、所有模板策略以及其他用户的策略（但不可编辑/删除）。

**响应**: 返回一个策略对象数组。每个对象都包含 `can_edit` 和 `can_delete` 字段，指示当前用户是否可以编辑或删除该策略。

**Section sources**
- [backtest.py](file://zquant/api/v1/backtest.py#L252-L327)
- [strategy.py](file://zquant/services/strategy.py#L128-L175)

### 获取模板策略列表

**端点**: `GET /api/v1/backtest/strategies/templates`

此端点专门用于获取所有标记为模板的策略。所有用户均可访问此列表，但只有创建者或管理员可以修改或删除。

**查询参数**:
- `category` (string, 可选): 按分类筛选模板策略。
- `skip`, `limit`: 分页参数。

**Section sources**
- [backtest.py](file://zquant/api/v1/backtest.py#L330-L340)
- [strategy.py](file://zquant/services/strategy.py#L178-L188)

### 获取策略详情 (Read - Detail)

**端点**: `GET /api/v1/backtest/strategies/{strategy_id}`

此端点用于获取指定ID的策略的完整详情。

**路径参数**:
- `strategy_id` (integer): 要查询的策略的ID。

**响应**: 返回一个包含策略所有信息的 `StrategyResponse` 对象。

**Section sources**
- [backtest.py](file://zquant/api/v1/backtest.py#L343-L351)
- [strategy.py](file://zquant/services/strategy.py#L68-L71)

### 更新策略 (Update)

**端点**: `PUT /api/v1/backtest/strategies/{strategy_id}`

此端点用于更新现有策略的信息。

**路径参数**:
- `strategy_id` (integer): 要更新的策略的ID。

**请求体**: 包含需要更新的字段，如 `name`, `code`, `description`, `category`, `params_schema`。未提供的字段将保持不变。

**权限**: 用户只能更新自己创建的策略。模板策略只能由其创建者更新。

**Section sources**
- [backtest.py](file://zquant/api/v1/backtest.py#L354-L379)
- [strategy.py](file://zquant/services/strategy.py#L74-L108)

### 删除策略 (Delete)

**端点**: `DELETE /api/v1/backtest/strategies/{strategy_id}`

此端点用于删除指定的策略。

**路径参数**:
- `strategy_id` (integer): 要删除的策略的ID。

**权限**: 用户只能删除自己创建的策略。模板策略只能由其创建者删除。

**响应**: 成功时返回 `204 No Content`。

**Section sources**
- [backtest.py](file://zquant/api/v1/backtest.py#L382-L394)
- [strategy.py](file://zquant/services/strategy.py#L111-L125)

## 策略权限模型

ZQuant平台的策略权限模型基于用户身份和策略的 `is_template` 属性，确保了策略的隔离性和共享性。

### 权限判断逻辑

当用户请求获取策略列表 (`GET /api/v1/backtest/strategies`) 时，后端会根据 `include_all` 参数和用户身份执行不同的查询逻辑：

1.  **`include_all=false` (默认)**:
    *   仅返回**当前用户自己创建**的策略。
    *   这保证了用户私有策略的安全性。

2.  **`include_all=true`**:
    *   返回一个更广泛的列表，包括：
        *   当前用户自己的所有策略。
        *   所有标记为 `is_template=True` 的**模板策略**。
        *   其他用户创建的**非模板策略**。
    *   这种设计允许用户在创建新策略或运行回测时，能够发现和参考他人的工作。

### 编辑与删除权限

即使一个策略在列表中可见，其编辑和删除权限也受到严格限制。系统在返回策略列表时，会动态添加 `can_edit` 和 `can_delete` 字段：

```python
# 伪代码逻辑
for strategy in strategies:
    # 基础权限：只能编辑/删除自己创建的策略
    can_edit = (strategy.user_id == current_user.id)
    can_delete = (strategy.user_id == current_user.id)

    # 额外限制：模板策略不能被非创建者修改
    if strategy.is_template and strategy.user_id != current_user.id:
        can_edit = False
        can_delete = False

    # 将权限字段附加到响应中
    strategy_response = {**strategy.dict(), "can_edit": can_edit, "can_delete": can_delete}
```

**总结**:
-   **私有策略**: 仅创建者可见、可编辑、可删除。
-   **模板策略**: 所有用户可见，但仅创建者可编辑和删除。
-   **他人非模板策略**: 在 `include_all=true` 时可见，但不可编辑或删除。

**Section sources**
- [backtest.py](file://zquant/api/v1/backtest.py#L296-L309)
- [strategy.py](file://zquant/services/strategy.py#L191-L264)

## 策略参数模式（params_schema）

`params_schema` 是一个强大的功能，它允许策略定义其可配置参数的结构，从而在前端实现动态表单生成。

### 动态表单生成

当用户在Web界面中创建或编辑策略时，如果策略的 `params_schema` 字段包含有效的JSON Schema，系统会自动解析该Schema，并生成一个对应的配置表单。用户可以通过这个表单直观地设置策略参数，而无需直接编辑代码。

**示例**:
```json
{
  "short_window": {
    "type": "number",
    "default": 5,
    "description": "短期均线周期"
  },
  "long_window": {
    "type": "number",
    "default": 20,
    "description": "长期均线周期"
  },
  "position_ratio": {
    "type": "number",
    "default": 0.8,
    "description": "目标持仓比例"
  }
}
```
上述Schema会在前端生成一个包含三个输入框的表单，分别对应短周期、长周期和持仓比例。

### 在策略代码中使用参数

在策略的 `initialize` 方法中，通过 `self.params.get()` 方法来获取这些参数的值。`params_schema` 中定义的 `default` 值将作为 `get()` 方法的默认参数。

```python
def initialize(self):
    # 从 params_schema 中获取参数，如果未设置则使用默认值
    self.short_window = self.params.get("short_window", 5)
    self.long_window = self.params.get("long_window", 20)
    self.position_ratio = self.params.get("position_ratio", 0.8)
```

**Section sources**
- [strategy_management.md](file://docs/strategy_management.md#L360-L362)
- [web/src/pages/backtest/strategies/create.tsx](file://web/src/pages/backtest/strategies/create.tsx#L230-L238)

## 模板策略与共享机制

模板策略是系统预置或由管理员/高级用户创建的高质量策略，旨在为其他用户提供学习和参考的范例。

### 共享机制

1.  **创建模板**: 管理员或高级用户在创建策略时，将 `is_template` 字段设置为 `true`。
2.  **全局可见**: 所有用户都可以通过 `GET /api/v1/backtest/strategies?include_all=true` 或 `GET /api/v1/backtest/strategies/templates` 端点看到这些模板策略。
3.  **只读访问**: 普通用户可以查看模板策略的代码和描述，但无法修改或删除它们，保证了模板的稳定性和权威性。
4.  **复用与衍生**: 用户可以复制模板策略的代码，在此基础上创建自己的新策略，从而快速启动开发。

### 搜索与过滤

策略列表API支持强大的搜索和过滤功能，帮助用户快速找到所需的策略。

*   **按分类过滤**: 使用 `category` 参数，例如 `?category=technical` 可以筛选出所有技术分析类策略。
*   **关键词搜索**: 使用 `search` 参数，例如 `?search=均线` 可以在策略名称和描述中搜索包含“均线”的策略。
*   **组合使用**: 这些参数可以组合使用，例如 `?category=technical&search=均线&is_template=true` 可以精确地找到所有技术分析类且名称或描述包含“均线”的模板策略。

**Section sources**
- [strategy_management.md](file://docs/strategy_management.md#L28-L45)
- [init_strategies.py](file://zquant/scripts/init_strategies.py#L48-L104)

## 策略代码结构规范与最佳实践

为了确保策略的兼容性和可维护性，遵循以下代码结构规范至关重要。

### 核心结构

每个策略代码必须包含一个名为 `Strategy` 的类，该类继承自 `zquant.backtest.strategy.BaseStrategy`。

```python
from zquant.backtest.context import Context
from zquant.backtest.strategy import BaseStrategy

class Strategy(BaseStrategy):
    def initialize(self):
        # 初始化逻辑
        pass
    
    def on_bar(self, context: Context, bar_data: dict):
        # 交易逻辑
        pass
```

### `initialize` 方法

此方法在回测开始前被调用一次，用于初始化策略状态和参数。

**最佳实践**:
-   使用 `self.params.get()` 来获取可配置参数。
-   初始化用于存储历史数据的变量（如 `self.price_history`）。
-   设置策略的初始状态。

```python
def initialize(self):
    self.short_window = self.params.get("short_window", 5)
    self.long_window = self.params.get("long_window", 20)
    self.price_history = {}
```

### `on_bar` 方法

此方法是策略的核心，它在每个交易日（或每个K线周期）被调用，接收最新的市场数据。

**最佳实践**:
-   **遍历 `bar_data`**: `bar_data` 是一个字典，键为股票代码，值为包含 `open`, `high`, `low`, `close`, `volume` 等字段的字典。
-   **获取上下文**: 使用 `context` 对象来查询投资组合、下达订单。
-   **处理持仓**: 使用 `context.portfolio.get_position(symbol)` 来获取特定股票的持仓信息。
-   **下达订单**: 使用 `context.order_target_value(symbol, target_value)` 等方法来下达订单。

```python
def on_bar(self, context: Context, bar_data: dict):
    for symbol, bar in bar_data.items():
        # 获取当前价格和持仓
        current_price = bar["close"]
        pos = context.portfolio.get_position(symbol)
        
        # 更新历史数据
        if symbol not in self.price_history:
            self.price_history[symbol] = []
        self.price_history[symbol].append(current_price)
        
        # 计算均线
        if len(self.price_history[symbol]) >= self.long_window:
            prices = self.price_history[symbol][-self.long_window:]
            short_ma = sum(prices[-self.short_window:]) / self.short_window
            long_ma = sum(prices) / len(prices)
            
            # 交易逻辑
            if short_ma > long_ma and pos.quantity == 0:
                # 买入
                context.order_target_value(symbol, context.portfolio.total_value * 0.3)
            elif short_ma < long_ma and pos.quantity > 0:
                # 卖出
                context.order_target(symbol, 0)
```

**Section sources**
- [backtest.py](file://zquant/api/v1/backtest.py#L184-L213)
- [simple_ma.py](file://zquant/strategy/examples/simple_ma.py#L12-L59)
- [dual_ma.py](file://zquant/strategy/examples/dual_ma.py#L27-L99)

## API请求/响应示例

### 创建策略

**请求**:
```bash
curl -X POST "http://localhost:8000/api/v1/backtest/strategies" \
  -H "Authorization: Bearer <your_jwt_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "双均线策略",
    "code": "class Strategy(BaseStrategy): ...",
    "description": "一个增强版的双均线策略",
    "category": "technical",
    "params_schema": "{\"short_window\": {\"type\": \"integer\", \"default\": 5}, \"long_window\": {\"type\": \"integer\", \"default\": 20}}",
    "is_template": false
  }'
```

**响应**:
```json
{
  "id": 1,
  "user_id": 1,
  "name": "双均线策略",
  "description": "一个增强版的双均线策略",
  "category": "technical",
  "code": "class Strategy(BaseStrategy): ...",
  "params_schema": "{\"short_window\": {\"type\": \"integer\", \"default\": 5}, \"long_window\": {\"type\": \"integer\", \"default\": 20}}",
  "is_template": false,
  "created_at": "2025-04-05T10:00:00",
  "updated_at": "2025-04-05T10:00:00",
  "can_edit": true,
  "can_delete": true
}
```

### 获取策略列表

**请求**:
```bash
curl "http://localhost:8000/api/v1/backtest/strategies?include_all=true&category=technical&search=均线" \
  -H "Authorization: Bearer <your_jwt_token>"
```

**响应**:
```json
[
  {
    "id": 1,
    "user_id": 1,
    "name": "双均线策略",
    "description": "一个增强版的双均线策略",
    "category": "technical",
    "code": "...",
    "params_schema": "...",
    "is_template": false,
    "created_at": "2025-04-05T10:00:00",
    "updated_at": "2025-04-05T10:00:00",
    "can_edit": true,
    "can_delete": true
  },
  {
    "id": 2,
    "user_id": 2,
    "name": "简单均线策略",
    "description": "当短期均线上穿长期均线时买入，下穿时卖出。",
    "category": "technical",
    "code": "...",
    "params_schema": "...",
    "is_template": true,
    "created_at": "2025-04-04T09:00:00",
    "updated_at": "2025-04-04T09:00:00",
    "can_edit": false,
    "can_delete": false
  }
]
```

**Section sources**
- [api_reference.md](file://docs/api/api_reference.md#L375-L387)
- [strategy_management.md](file://docs/strategy_management.md#L77-L85)

## 在回测中引用策略

回测API (`/api/v1/backtest/run`) 支持两种方式来指定策略，极大地提高了灵活性。

### 方式一：通过策略ID引用

这是推荐的方式，适用于使用已保存在策略库中的策略。

**请求体**:
```json
{
  "strategy_id": 1,
  "strategy_name": "测试回测",
  "config": {
    "start_date": "2023-01-01",
    "end_date": "2023-12-31",
    "initial_capital": 1000000,
    "symbols": ["000001.SZ", "000002.SZ"],
    "frequency": "daily",
    "params": {
      "short_window": 10,
      "long_window": 30
    }
  }
}
```
-   `strategy_id`: 指向策略库中已保存的策略。
-   `params`: (可选) 用于覆盖策略 `params_schema` 中定义的默认参数。

### 方式二：直接提供策略代码

适用于临时测试或不想保存的策略。

**请求体**:
```json
{
  "strategy_code": "from zquant.backtest.strategy import BaseStrategy\n\nclass Strategy(BaseStrategy):\n    def on_bar(self, context, bar_data):\n        # 临时策略逻辑\n        pass",
  "strategy_name": "临时策略回测",
  "config": {
    "start_date": "2023-01-01",
    "end_date": "2023-12-31",
    "initial_capital": 1000000,
    "symbols": ["000001.SZ"]
  }
}
```
-   `strategy_code`: 直接内联策略的Python代码。

**Section sources**
- [strategy_management.md](file://docs/strategy_management.md#L109-L131)
- [backtest.py](file://zquant/api/v1/backtest.py#L91-L116)