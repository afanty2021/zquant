# 审计日志实现机制

<cite>
**本文档引用的文件**  
- [audit.py](file://zquant/middleware/audit.py)
- [main.py](file://zquant/main.py)
- [auth.py](file://zquant/api/v1/auth.py)
- [users.py](file://zquant/api/v1/users.py)
- [backtest.py](file://zquant/api/v1/backtest.py)
- [auth.py](file://zquant/services/auth.py)
- [deps.py](file://zquant/api/deps.py)
- [config.py](file://zquant/config.py)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心组件](#核心组件)
3. [审计日志中间件分析](#审计日志中间件分析)
4. [审计触发逻辑](#审计触发逻辑)
5. [审计级别判断机制](#审计级别判断机制)
6. [日志信息收集与记录](#日志信息收集与记录)
7. [敏感操作与普通操作处理策略](#敏感操作与普通操作处理策略)
8. [配置项分析](#配置项分析)

## 项目结构

```mermaid
graph TD
A[zquant] --> B[middleware]
A --> C[api]
A --> D[services]
A --> E[models]
A --> F[config.py]
A --> G[main.py]
B --> H[audit.py]
C --> I[v1]
I --> J[auth.py]
I --> K[users.py]
I --> L[backtest.py]
D --> M[auth.py]
F --> N[Settings]
G --> O[FastAPI应用]
H -- "注册" --> O
J -- "触发审计" --> H
K -- "触发审计" --> H
L -- "触发审计" --> H
M -- "设置用户状态" --> O
```

**图示来源**
- [audit.py](file://zquant/middleware/audit.py)
- [main.py](file://zquant/main.py)
- [auth.py](file://zquant/api/v1/auth.py)
- [users.py](file://zquant/api/v1/users.py)
- [backtest.py](file://zquant/api/v1/backtest.py)
- [auth.py](file://zquant/services/auth.py)
- [config.py](file://zquant/config.py)

## 核心组件

zquant平台的审计日志实现机制主要由以下几个核心组件构成：审计中间件(AuditMiddleware)、API路由、认证服务(AuthService)和配置系统(Settings)。这些组件协同工作，实现了对敏感操作的全面审计和日志记录。

**组件来源**
- [audit.py](file://zquant/middleware/audit.py)
- [main.py](file://zquant/main.py)
- [auth.py](file://zquant/services/auth.py)
- [config.py](file://zquant/config.py)

## 审计日志中间件分析

审计日志中间件(AuditMiddleware)是zquant平台安全审计的核心组件，它继承自FastAPI的BaseHTTPMiddleware，通过拦截所有HTTP请求来实现审计功能。该中间件在请求处理的前后阶段收集关键信息，并根据操作的敏感程度和执行结果选择适当的日志级别进行记录。

```mermaid
classDiagram
class AuditMiddleware {
+AUDIT_METHODS : list[str]
+AUDIT_PATHS : list[str]
+SENSITIVE_PATHS : list[str]
-_should_audit(method : str, path : str) : bool
-_is_sensitive(path : str) : bool
+dispatch(request : Request, call_next : Callable) : Response
}
class BaseHTTPMiddleware {
<<abstract>>
+dispatch(request : Request, call_next : Callable) : Response
}
AuditMiddleware --|> BaseHTTPMiddleware
```

**图示来源**
- [audit.py](file://zquant/middleware/audit.py#L36-L159)

## 审计触发逻辑

审计中间件通过`_should_audit`方法判断是否需要对特定请求进行审计。该方法的触发逻辑基于两个关键条件：HTTP方法类型和请求路径模式。

```mermaid
flowchart TD
Start([开始]) --> CheckMethod["检查HTTP方法"]
CheckMethod --> MethodValid{"方法是否在<br/>AUDIT_METHODS中?"}
MethodValid --> |否| SkipAudit["跳过审计"]
MethodValid --> |是| CheckPath["检查路径模式"]
CheckPath --> PathValid{"路径是否以<br/>AUDIT_PATHS中<br/>任一模式开头?"}
PathValid --> |否| SkipAudit
PathValid --> |是| PerformAudit["执行审计"]
SkipAudit --> End([结束])
PerformAudit --> End
```

**图示来源**
- [audit.py](file://zquant/middleware/audit.py#L63-L77)

## 审计级别判断机制

审计级别判断机制由`_should_audit`和`_is_sensitive`两个私有方法协同工作实现。`_should_audit`方法基于AUDIT_METHODS和AUDIT_PATHS配置项判断操作是否需要审计，而`_is_sensitive`方法则基于SENSITIVE_PATHS配置项判断操作是否为敏感操作。

```mermaid
sequenceDiagram
participant Request as "HTTP请求"
participant AuditMiddleware as "AuditMiddleware"
participant ShouldAudit as "_should_audit()"
participant IsSensitive as "_is_sensitive()"
Request->>AuditMiddleware : 发起请求
AuditMiddleware->>ShouldAudit : 调用_should_audit(method, path)
ShouldAudit-->>AuditMiddleware : 返回是否需要审计
alt 需要审计
AuditMiddleware->>IsSensitive : 调用_is_sensitive(path)
IsSensitive-->>AuditMiddleware : 返回是否为敏感操作
AuditMiddleware->>AuditMiddleware : 收集审计信息
AuditMiddleware->>AuditMiddleware : 记录审计日志
end
AuditMiddleware-->>Request : 返回响应
```

**图示来源**
- [audit.py](file://zquant/middleware/audit.py#L63-L90)

## 日志信息收集与记录

审计中间件在请求处理前后收集多种关键信息，并以结构化JSON格式记录到日志系统。信息收集过程包括用户身份、客户端信息、请求体（含脱敏处理）和响应状态码等。

```mermaid
flowchart TD
A[开始] --> B[获取请求方法和路径]
B --> C[判断是否需要审计]
C --> |否| D[直接处理请求]
C --> |是| E[获取用户信息]
E --> F[获取客户端IP]
F --> G[判断是否为敏感操作]
G --> |是| H[读取并脱敏请求体]
G --> |否| I[跳过请求体]
H --> J[处理请求]
I --> J
J --> K[获取响应状态码]
K --> L[构建审计数据]
L --> M[根据敏感度和结果选择日志级别]
M --> N[记录审计日志]
N --> O[返回响应]
```

**图示来源**
- [audit.py](file://zquant/middleware/audit.py#L91-L159)

## 敏感操作与普通操作处理策略

系统对敏感操作和普通操作采用不同的日志级别处理策略。敏感操作（如用户管理、回测创建）在成功时使用INFO级别，在失败时使用WARNING级别；而普通操作则统一使用DEBUG级别记录。

```mermaid
flowchart TD
A[审计操作] --> B{是否为敏感操作?}
B --> |是| C{操作是否成功?}
B --> |否| D[使用DEBUG级别记录]
C --> |是| E[使用INFO级别记录<br/>\"敏感操作成功\"]
C --> |否| F[使用WARNING级别记录<br/>\"敏感操作失败\"]
E --> G[结束]
F --> G
D --> G
```

**图示来源**
- [audit.py](file://zquant/middleware/audit.py#L150-L157)

## 配置项分析

审计功能的配置主要通过AUDIT_METHODS、AUDIT_PATHS和SENSITIVE_PATHS三个类属性实现。这些配置项定义了哪些HTTP方法、路径模式需要审计，以及哪些路径属于敏感操作。

```mermaid
erDiagram
CONFIG ||--o{ AUDIT_METHODS : "包含"
CONFIG ||--o{ AUDIT_PATHS : "包含"
CONFIG ||--o{ SENSITIVE_PATHS : "包含"
CONFIG {
string name
}
AUDIT_METHODS {
string method PK
}
AUDIT_PATHS {
string path PK
}
SENSITIVE_PATHS {
string path PK
}
```

**图示来源**
- [audit.py](file://zquant/middleware/audit.py#L43-L61)