# 层级交互与业务流程

<cite>
**本文引用的文件**
- [zquant/models/factor.py](file://zquant/models/factor.py)
- [zquant/services/factor.py](file://zquant/services/factor.py)
- [zquant/services/factor_calculation.py](file://zquant/services/factor_calculation.py)
- [zquant/factor/calculators/base.py](file://zquant/factor/calculators/base.py)
- [zquant/factor/calculators/factory.py](file://zquant/factor/calculators/factory.py)
- [zquant/factor/calculators/turnover_rate.py](file://zquant/factor/calculators/turnover_rate.py)
- [zquant/api/v1/factor.py](file://zquant/api/v1/factor.py)
- [zquant/scripts/init_factor.py](file://zquant/scripts/init_factor.py)
- [docs/factor_management.md](file://docs/factor_management.md)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考量](#性能考量)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)

## 简介
本文件系统化梳理因子层级在实际业务场景中的交互流程，重点围绕以下主题展开：
- 因子启用/禁用：FactorDefinition.enabled 与 FactorConfig.enabled 的优先级关系与合并逻辑
- 新因子创建：系统如何自动初始化默认模型与配置记录
- 因子计算：FactorCalculationService 如何依据 FactorConfig 的 mappings 动态选择目标股票与对应模型
- 时序图：从 API 请求到最终调用具体计算器（如 turnover_rate_calculator）的完整调用链路，突出各层级模型间的协作关系

## 项目结构
围绕因子层级交互的关键模块分布如下：
- 模型层：FactorDefinition、FactorModel、FactorConfig（定义与持久化）
- 服务层：FactorService（因子定义/模型/配置管理）、FactorCalculationService（因子计算与结果落库）
- 计算器层：BaseFactorCalculator 抽象、TurnoverRateCalculator 实现、CalculatorFactory 工厂
- API 层：/api/v1/factor 提供因子定义、模型、配置与计算的 REST 接口
- 初始化脚本：scripts/init_factor.py 负责创建表、初始化换手率因子与示例配置

```mermaid
graph TB
subgraph "API 层"
API["/api/v1/factor.py<br/>因子API路由"]
end
subgraph "服务层"
SvcFactor["services/factor.py<br/>FactorService"]
SvcCalc["services/factor_calculation.py<br/>FactorCalculationService"]
end
subgraph "模型层"
MDef["models/factor.py<br/>FactorDefinition/FactorModel/FactorConfig"]
end
subgraph "计算器层"
Base["factor/calculators/base.py<br/>BaseFactorCalculator"]
Factory["factor/calculators/factory.py<br/>CalculatorFactory"]
TR["factor/calculators/turnover_rate.py<br/>TurnoverRateCalculator"]
end
API --> SvcFactor
API --> SvcCalc
SvcFactor --> MDef
SvcCalc --> MDef
SvcCalc --> Factory
Factory --> Base
Base --> TR
```

图表来源
- [zquant/api/v1/factor.py](file://zquant/api/v1/factor.py#L1-L120)
- [zquant/services/factor.py](file://zquant/services/factor.py#L1-L120)
- [zquant/services/factor_calculation.py](file://zquant/services/factor_calculation.py#L1-L120)
- [zquant/models/factor.py](file://zquant/models/factor.py#L1-L120)
- [zquant/factor/calculators/base.py](file://zquant/factor/calculators/base.py#L1-L82)
- [zquant/factor/calculators/factory.py](file://zquant/factor/calculators/factory.py#L1-L90)
- [zquant/factor/calculators/turnover_rate.py](file://zquant/factor/calculators/turnover_rate.py#L1-L80)

章节来源
- [zquant/api/v1/factor.py](file://zquant/api/v1/factor.py#L1-L120)
- [zquant/services/factor.py](file://zquant/services/factor.py#L1-L120)
- [zquant/services/factor_calculation.py](file://zquant/services/factor_calculation.py#L1-L120)
- [zquant/models/factor.py](file://zquant/models/factor.py#L1-L120)
- [zquant/factor/calculators/base.py](file://zquant/factor/calculators/base.py#L1-L82)
- [zquant/factor/calculators/factory.py](file://zquant/factor/calculators/factory.py#L1-L90)
- [zquant/factor/calculators/turnover_rate.py](file://zquant/factor/calculators/turnover_rate.py#L1-L80)

## 核心组件
- 因子定义（FactorDefinition）：承载因子元信息与启用状态，并提供配置读写入口
- 因子模型（FactorModel）：承载模型元信息、启用状态、默认标志与模型配置
- 因子配置（FactorConfig）：以 JSON 形式存储配置，包含 enabled 与 mappings 列表
- FactorService：负责因子定义、模型、配置的 CRUD 与校验
- FactorCalculationService：负责因子计算调度、缓存、结果落库
- BaseFactorCalculator/CalculatorFactory：计算器抽象与工厂，按 model_code 分发具体计算器
- API 路由：对外暴露因子定义、模型、配置与计算接口

章节来源
- [zquant/models/factor.py](file://zquant/models/factor.py#L35-L120)
- [zquant/services/factor.py](file://zquant/services/factor.py#L38-L120)
- [zquant/services/factor_calculation.py](file://zquant/services/factor_calculation.py#L1-L120)
- [zquant/factor/calculators/base.py](file://zquant/factor/calculators/base.py#L1-L82)
- [zquant/factor/calculators/factory.py](file://zquant/factor/calculators/factory.py#L1-L90)

## 架构总览
下图展示从 API 请求到计算器执行的完整调用链路，强调 FactorConfig 的 mappings 如何驱动模型选择与股票集合。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant API as "API 路由<br/>/api/v1/factor.py"
participant SvcCalc as "FactorCalculationService"
participant SvcFactor as "FactorService"
participant Cache as "FactorCalculationCache"
participant DB as "数据库"
participant Factory as "CalculatorFactory"
participant Calc as "TurnoverRateCalculator"
Client->>API : POST /api/v1/factor/calculate
API->>SvcCalc : calculate_factor(...)
SvcCalc->>SvcFactor : list_factor_definitions(enabled=true)
SvcFactor->>DB : 查询启用的因子定义
DB-->>SvcFactor : 因子定义列表
SvcFactor-->>SvcCalc : 返回因子定义
SvcCalc->>Cache : 构造缓存(批量加载默认模型/配置/模型)
Cache->>DB : 查询默认模型(按factor_id, enabled=true)
Cache->>DB : 查询配置(按factor_id, enabled=true)
Cache->>DB : 收集并加载配置中使用的模型
DB-->>Cache : 默认模型/配置/模型集合
loop 遍历交易日
loop 遍历因子
SvcCalc->>Cache : get_default_model(factor_id)
alt 无默认模型
SvcCalc-->>SvcCalc : 跳过该因子
else 有默认模型
SvcCalc->>Cache : get_config(factor_id)
alt 无配置
SvcCalc->>DB : 获取所有股票代码
SvcCalc->>SvcCalc : 逐股票使用默认模型计算
else 有配置
SvcCalc->>Cache : get_model_for_code(factor_id, code)
alt 代码命中特定映射
Cache-->>SvcCalc : 返回指定模型
else 未命中
Cache-->>SvcCalc : 返回默认映射模型或默认模型
end
SvcCalc->>Factory : create_calculator(model_code, config)
Factory-->>SvcCalc : 返回计算器实例
SvcCalc->>Calc : calculate(db, code, trade_date)
Calc-->>SvcCalc : 返回因子值
SvcCalc->>DB : 保存结果(表不存在则创建并加列)
end
end
end
end
SvcCalc-->>API : 返回计算结果
API-->>Client : 响应
```

图表来源
- [zquant/api/v1/factor.py](file://zquant/api/v1/factor.py#L733-L757)
- [zquant/services/factor_calculation.py](file://zquant/services/factor_calculation.py#L576-L996)
- [zquant/services/factor.py](file://zquant/services/factor.py#L579-L629)
- [zquant/factor/calculators/factory.py](file://zquant/factor/calculators/factory.py#L53-L79)
- [zquant/factor/calculators/turnover_rate.py](file://zquant/factor/calculators/turnover_rate.py#L59-L154)

章节来源
- [zquant/api/v1/factor.py](file://zquant/api/v1/factor.py#L733-L757)
- [zquant/services/factor_calculation.py](file://zquant/services/factor_calculation.py#L576-L996)
- [zquant/services/factor.py](file://zquant/services/factor.py#L579-L629)
- [zquant/factor/calculators/factory.py](file://zquant/factor/calculators/factory.py#L53-L79)
- [zquant/factor/calculators/turnover_rate.py](file://zquant/factor/calculators/turnover_rate.py#L59-L154)

## 详细组件分析

### 因子启用/禁用优先级与合并逻辑
- FactorDefinition.enabled：控制因子是否参与计算（在计算入口处被检查）
- FactorConfig.enabled：控制该因子的配置是否生效（在配置加载与模型选择阶段被检查）
- 合并逻辑：
  - 若因子未启用（FactorDefinition.enabled=false），直接跳过该因子的计算
  - 若因子启用，但配置未启用（FactorConfig.enabled=false），则视为无配置，使用默认模型对全市场或配置的股票集合进行计算
  - 若配置启用，则按 mappings 的规则选择模型与股票集合

```mermaid
flowchart TD
Start(["开始"]) --> CheckDef["检查因子是否启用(FactorDefinition.enabled)"]
CheckDef --> DefEnabled{"因子启用？"}
DefEnabled --> |否| Skip["跳过该因子"]
DefEnabled --> |是| LoadCfg["加载因子配置(FactorConfig)"]
LoadCfg --> CfgEnabled{"配置启用？"}
CfgEnabled --> |否| UseDefault["视为无配置，使用默认模型"]
CfgEnabled --> |是| ParseMappings["解析mappings"]
ParseMappings --> SelectStocks["确定股票集合"]
SelectStocks --> SelectModel["确定模型(默认或映射)"]
SelectModel --> Compute["调用计算器计算"]
Compute --> Save["保存结果"]
Save --> End(["结束"])
Skip --> End
UseDefault --> Compute
```

图表来源
- [zquant/services/factor_calculation.py](file://zquant/services/factor_calculation.py#L714-L740)
- [zquant/services/factor_calculation.py](file://zquant/services/factor_calculation.py#L776-L871)
- [zquant/services/factor.py](file://zquant/services/factor.py#L579-L629)

章节来源
- [zquant/services/factor_calculation.py](file://zquant/services/factor_calculation.py#L714-L740)
- [zquant/services/factor_calculation.py](file://zquant/services/factor_calculation.py#L776-L871)
- [zquant/services/factor.py](file://zquant/services/factor.py#L579-L629)

### 新因子创建时的默认模型与配置初始化
- 创建因子定义时可附带初始配置（factor_config），系统会将其写入 FactorConfig 表
- 初始化脚本会创建默认模型（如“换手率计算模型（每日指标）”）并设置为默认
- 示例配置包含多映射：默认模型用于所有股票，特定模型用于部分股票
- 若未显式创建配置，计算时将视为无配置，使用默认模型对全市场计算

章节来源
- [zquant/services/factor.py](file://zquant/services/factor.py#L43-L88)
- [zquant/scripts/init_factor.py](file://zquant/scripts/init_factor.py#L243-L302)
- [zquant/scripts/init_factor.py](file://zquant/scripts/init_factor.py#L304-L384)

### FactorCalculationService 如何根据 mappings 动态选择目标股票与模型
- 股票集合选择：
  - 若配置中包含 codes 列表，则仅计算该列表中的股票
  - 若 codes 为空或 None，则计算全市场股票
- 模型选择：
  - 先按代码匹配特定映射，若命中则使用映射中的 model_id
  - 若未命中，使用默认映射（codes 为空或 None）所指向的 model_id
  - 若仍无默认映射，回退到因子定义的默认模型
- 计算器创建与执行：
  - 依据 model_code 与模型配置创建具体计算器
  - 调用计算器 calculate 并保存结果

章节来源
- [zquant/services/factor_calculation.py](file://zquant/services/factor_calculation.py#L245-L264)
- [zquant/services/factor_calculation.py](file://zquant/services/factor_calculation.py#L156-L209)
- [zquant/services/factor_calculation.py](file://zquant/services/factor_calculation.py#L895-L996)
- [zquant/factor/calculators/factory.py](file://zquant/factor/calculators/factory.py#L53-L79)

### 时序图：从 API 到具体计算器的调用链
```mermaid
sequenceDiagram
participant Client as "客户端"
participant API as "API 路由"
participant SvcCalc as "FactorCalculationService"
participant SvcFactor as "FactorService"
participant Cache as "FactorCalculationCache"
participant Factory as "CalculatorFactory"
participant TR as "TurnoverRateCalculator"
Client->>API : POST /api/v1/factor/calculate
API->>SvcCalc : calculate_factor(...)
SvcCalc->>SvcFactor : list_factor_definitions(enabled=true)
SvcFactor-->>SvcCalc : 因子定义列表
SvcCalc->>Cache : 构造缓存(默认模型/配置/模型)
loop 遍历交易日
loop 遍历因子
SvcCalc->>Cache : get_default_model/get_config
alt 无配置
SvcCalc->>DB : 获取全市场股票
else 有配置
SvcCalc->>Cache : get_model_for_code(code)
Cache-->>SvcCalc : 返回模型
end
SvcCalc->>Factory : create_calculator(model_code, config)
Factory-->>SvcCalc : 返回计算器
SvcCalc->>TR : calculate(db, code, trade_date)
TR-->>SvcCalc : 返回因子值
SvcCalc->>DB : 保存结果
end
end
SvcCalc-->>API : 返回结果
API-->>Client : 响应
```

图表来源
- [zquant/api/v1/factor.py](file://zquant/api/v1/factor.py#L733-L757)
- [zquant/services/factor_calculation.py](file://zquant/services/factor_calculation.py#L576-L996)
- [zquant/factor/calculators/factory.py](file://zquant/factor/calculators/factory.py#L53-L79)
- [zquant/factor/calculators/turnover_rate.py](file://zquant/factor/calculators/turnover_rate.py#L59-L154)

章节来源
- [zquant/api/v1/factor.py](file://zquant/api/v1/factor.py#L733-L757)
- [zquant/services/factor_calculation.py](file://zquant/services/factor_calculation.py#L576-L996)
- [zquant/factor/calculators/factory.py](file://zquant/factor/calculators/factory.py#L53-L79)
- [zquant/factor/calculators/turnover_rate.py](file://zquant/factor/calculators/turnover_rate.py#L59-L154)

## 依赖关系分析
- FactorDefinition 与 FactorConfig：一对一关系，配置以 JSON 字段存储，FactorDefinition 提供便捷访问
- FactorModel 与 FactorDefinition：一对多关系，每个因子可有多个模型，其中最多一个默认模型
- FactorCalculationService 依赖 FactorService 获取因子定义与模型，依赖 FactorCalculationCache 减少数据库查询
- CalculatorFactory 依据 model_code 分发具体计算器，TurnoverRateCalculator 实现具体计算逻辑
- API 层通过 FactorCalculationService 暴露计算接口，内部构建 extra_info 传递给落库步骤

```mermaid
classDiagram
class FactorDefinition {
+int id
+string factor_name
+string cn_name
+string en_name
+string column_name
+bool enabled
+get_factor_config()
+set_factor_config(config)
}
class FactorModel {
+int id
+int factor_id
+string model_name
+string model_code
+dict config_json
+bool is_default
+bool enabled
+get_config()
+set_config(config)
}
class FactorConfig {
+int factor_id
+dict config_json
+bool enabled
+get_config()
+set_config(config)
+get_codes_list()
}
class FactorService {
+create_factor_definition(...)
+list_factor_definitions(...)
+create_factor_model(...)
+list_factor_models(...)
+get_model_for_code(...)
}
class FactorCalculationService {
+calculate_factor(...)
+ensure_factor_result_table(...)
+save_factor_result(...)
}
class BaseFactorCalculator {
+calculate(db, code, trade_date)
+validate_config()
}
class CalculatorFactory {
+create_calculator(model_code, config)
}
class TurnoverRateCalculator
FactorDefinition "1" o-- "many" FactorModel : "back_populates"
FactorDefinition "1" o-- "1" FactorConfig : "back_populates"
FactorService --> FactorDefinition
FactorService --> FactorModel
FactorService --> FactorConfig
FactorCalculationService --> FactorDefinition
FactorCalculationService --> FactorModel
FactorCalculationService --> FactorConfig
CalculatorFactory --> BaseFactorCalculator
BaseFactorCalculator <|-- TurnoverRateCalculator
```

图表来源
- [zquant/models/factor.py](file://zquant/models/factor.py#L35-L120)
- [zquant/services/factor.py](file://zquant/services/factor.py#L38-L120)
- [zquant/services/factor_calculation.py](file://zquant/services/factor_calculation.py#L1-L120)
- [zquant/factor/calculators/base.py](file://zquant/factor/calculators/base.py#L1-L82)
- [zquant/factor/calculators/factory.py](file://zquant/factor/calculators/factory.py#L1-L90)
- [zquant/factor/calculators/turnover_rate.py](file://zquant/factor/calculators/turnover_rate.py#L1-L80)

章节来源
- [zquant/models/factor.py](file://zquant/models/factor.py#L35-L120)
- [zquant/services/factor.py](file://zquant/services/factor.py#L38-L120)
- [zquant/services/factor_calculation.py](file://zquant/services/factor_calculation.py#L1-L120)
- [zquant/factor/calculators/base.py](file://zquant/factor/calculators/base.py#L1-L82)
- [zquant/factor/calculators/factory.py](file://zquant/factor/calculators/factory.py#L1-L90)
- [zquant/factor/calculators/turnover_rate.py](file://zquant/factor/calculators/turnover_rate.py#L1-L80)

## 性能考量
- 批量加载与缓存：FactorCalculationCache 一次性加载默认模型、配置与相关模型，减少多次查询
- 预计算映射：对特定代码与默认映射进行预计算，提升 get_model_for_code 的命中效率
- 数据表与列管理：按需创建因子结果表与列，避免重复 ALTER 操作
- 日志与进度：按批次输出进度，便于监控大规模计算的执行情况

章节来源
- [zquant/services/factor_calculation.py](file://zquant/services/factor_calculation.py#L44-L213)
- [zquant/services/factor_calculation.py](file://zquant/services/factor_calculation.py#L266-L373)

## 故障排查指南
- 因子未计算：
  - 检查 FactorDefinition.enabled 是否为真
  - 检查 FactorConfig.enabled 与 mappings 是否正确
- 计算器异常：
  - 确认 model_code 是否在工厂注册
  - 校验模型配置 validate_config 的返回
- 结果未入库：
  - 检查 ensure_factor_result_table 与 save_factor_result 的错误日志
  - 确认表与列已创建成功
- API 权限：
  - 计算接口需要管理员权限，确认用户角色

章节来源
- [zquant/factor/calculators/factory.py](file://zquant/factor/calculators/factory.py#L53-L79)
- [zquant/factor/calculators/turnover_rate.py](file://zquant/factor/calculators/turnover_rate.py#L155-L176)
- [zquant/services/factor_calculation.py](file://zquant/services/factor_calculation.py#L266-L373)
- [zquant/api/v1/factor.py](file://zquant/api/v1/factor.py#L733-L757)

## 结论
- 启用优先级：因子启用（FactorDefinition.enabled）优先于配置启用（FactorConfig.enabled）。只有两者同时满足，配置才会生效
- 配置驱动：FactorConfig 的 mappings 决定股票集合与模型选择，支持默认映射与特定映射混合
- 初始化策略：创建因子定义时可附带配置；初始化脚本会创建默认模型与示例配置，便于快速上手
- 执行链路：API -> FactorCalculationService -> FactorCalculationCache -> CalculatorFactory -> 具体计算器 -> 结果落库

章节来源
- [zquant/services/factor_calculation.py](file://zquant/services/factor_calculation.py#L714-L740)
- [zquant/services/factor_calculation.py](file://zquant/services/factor_calculation.py#L776-L871)
- [zquant/services/factor.py](file://zquant/services/factor.py#L579-L629)
- [zquant/scripts/init_factor.py](file://zquant/scripts/init_factor.py#L243-L302)
- [docs/factor_management.md](file://docs/factor_management.md#L190-L259)